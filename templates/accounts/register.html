{% load static %}
<!DOCTYPE html>
<html dir="rtl" lang="ar" class="">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>إنشاء حساب جديد - منصة آية</title>
    <link rel="icon" type="image/png" href="{% static 'img/logo.png' %}">

    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: "#386641", light: "#6A994E", dark: "#A7C957" },
                        background: { DEFAULT: "#F7F9FC", dark: "#111827" },
                        card: { DEFAULT: "#FFFFFF", dark: "#1F2937" },
                        "text-primary": { DEFAULT: "#212529", dark: "#F9FAFB" },
                        "text-secondary": { DEFAULT: "#6C757D", dark: "#9CA3AF" },
                        border: { DEFAULT: "#E5E7EB", dark: "#374151" },
                        error: "#e63946",
                        warning: "#f59e0b",
                    },
                    fontFamily: { display: ["Cairo", "sans-serif"] },
                    borderRadius: { xl: "1rem", lg: "0.75rem" },
                    boxShadow: {
                        subtle: "0 4px 12px 0 rgba(0,0,0,.05)",
                        lifted: "0 10px 30px 0 rgba(0,0,0,.07)",
                    },
                    animation: {
                        'slide-in': 'slide-in 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards',
                        'slide-out': 'slide-out 0.5s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards',
                        'fade-in': 'fade-in 0.5s ease-out forwards',
                        'fade-out': 'fade-out 0.5s ease-in forwards'
                    },
                    keyframes: {
                        'slide-in': { '0%': { transform: 'translateX(100%)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        'slide-out': { '0%': { transform: 'translateX(0)', opacity: 1 }, '100%': { transform: 'translateX(-100%)', opacity: 0 } },
                        'fade-in': { from: { opacity: 0 }, to: { opacity: 1 } },
                        'fade-out': { from: { opacity: 1 }, to: { opacity: 0 } }
                    }
                },
            },
        };
    </script>

    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
        .form-input-group { position: relative; }
        .form-input-group label {
            position: absolute; top: 50%; right: 1rem; transform: translateY(-50%);
            background: #FFFFFF; padding: 0 .25rem; color: #6C757D;
            font-size: 1rem; transition: all .2s ease-in-out; pointer-events: none;
        }
        .dark .form-input-group label { background: #1F2937; color: #9CA3AF; }
        .form-input:focus~label, .form-input:not(:placeholder-shown)~label {
            top: 0; font-size: .875rem; color: #386641;
        }
       .dark .form-input:focus~label { color: #A7C957; }
        
        #registration-form { transition: min-height 0.4s ease-in-out; }
        .step { display: none; }
        .step.active { display: block; animation: slide-in 0.5s ease-out; }
        .step.anim-out { animation: slide-out 0.5s ease-out forwards; }

        .typewriter-text {
            display: inline-block; overflow: hidden; white-space: nowrap;
            border-left: .15em solid #A7C957; animation: typing 2.5s steps(40, end), blink-caret .75s step-end infinite;
        }
        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: #A7C957; } }
        .modal { visibility: hidden; opacity: 0; transition: visibility 0s 0.3s, opacity 0.3s ease-in-out; }
        .modal.is-visible { visibility: visible; opacity: 1; transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-background dark:bg-background-dark font-display text-text-primary dark:text-text-primary-dark antialiased">

<button id="theme-toggle" class="absolute top-6 left-6 z-50 rounded-full p-2.5 bg-card dark:bg-card-dark shadow-subtle hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="تغيير المظهر">
    <span class="material-symbols-outlined text-text-secondary dark:text-text-secondary-dark" id="theme-icon"></span>
</button>

<div class="flex min-h-screen">
    <div class="w-full lg:w-1/2 flex flex-col justify-center items-center p-6 sm:p-12">
        <div id="form-container" class="w-full max-w-md my-auto">
            <div class="flex-shrink-0">
                <div class="text-center mb-8">
                    <a href="#" class="inline-block mb-4">
                        <div class="text-white w-16 h-16 rounded-2xl flex items-center justify-center shadow-subtle">
                            <img src="{% static 'img/logo2.png' %}" alt="شعار منصة آية" class="w-18 h-18">
                        </div>
                    </a>
                    <h1 class="text-3xl font-extrabold">إنشاء حساب جديد</h1>
                    <p class="text-text-secondary dark:text-text-secondary-dark mt-2">انضم إلينا وابدأ رحلتك القرآنية.</p>
                </div>
                <div class="flex items-center justify-between mb-8">
                    <div class="step-indicator" data-step="1"><div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">1</div><p class="text-xs text-center mt-1 font-semibold">الأساسيات</p></div>
                    <div class="flex-1 h-0.5 bg-border dark:bg-border-dark mx-2"></div>
                    <div class="step-indicator" data-step="2"><div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">2</div><p class="text-xs text-center mt-1 font-semibold">التفاصيل</p></div>
                    <div class="flex-1 h-0.5 bg-border dark:bg-border-dark mx-2"></div>
                    <div class="step-indicator" data-step="3"><div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">3</div><p class="text-xs text-center mt-1 font-semibold">الأمان</p></div>
                </div>
            </div>
            <div class="flex-grow">
                <form id="registration-form" method="post" action="{% url 'accounts:register' %}" enctype="multipart/form-data" class="overflow-hidden relative">
                    {% csrf_token %}
                    <input type="hidden" name="role" id="register-role" value="student" />
                    <div class="step absolute w-full" data-step="1"><div class="space-y-6 pt-2"><div class="form-input-group"><input id="full_name" name="full_name" type="text" placeholder=" " required class="form-input w-full p-4 rounded-lg bg-card dark:bg-card-dark border-2 border-border dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary placeholder-transparent text-lg"/><label for="full_name">الاسم الكامل <span class="text-error">*</span></label></div><div class="form-input-group"><input id="username" name="username" type="text" placeholder=" " required class="form-input w-full p-4 rounded-lg bg-card dark:bg-card-dark border-2 border-border dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary placeholder-transparent text-lg" pattern="[a-zA-Z0-9_]+" title="الرجاء استخدام الحروف الإنجليزية والأرقام والشرطة السفلية (_) فقط."/><label for="username">اسم المستخدم (للدخول) <span class="text-error">*</span></label></div><div class="form-input-group"><input id="email" name="email" type="email" placeholder=" " required class="form-input w-full p-4 rounded-lg bg-card dark:bg-card-dark border-2 border-border dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary placeholder-transparent text-lg"/><label for="email">البريد الإلكتروني <span class="text-error">*</span></label></div><div class="flex justify-end pt-4"><button type="button" class="next-btn w-full sm:w-auto bg-primary text-white font-bold py-3 px-8 rounded-lg hover:bg-primary-light transition-colors">التالي</button></div></div></div>
                    <div class="step absolute w-full" data-step="2"><div class="space-y-6 pt-2"><div id="role-selector" class="flex border border-border dark:border-border-dark rounded-lg p-1 bg-background dark:bg-background-dark/50"><button type="button" data-role="student" class="w-1/2 py-2.5 px-4 rounded-md text-center font-bold">طالب</button><button type="button" data-role="teacher" class="w-1/2 py-2.5 px-4 rounded-md text-center font-bold">معلم</button></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-6"><div class="form-input-group"><input id="birth_date" name="birth_date" type="text" placeholder=" " onfocus="(this.type='date')" onblur="(this.type='text')" class="form-input w-full p-4 rounded-lg bg-card dark:bg-card-dark border-2 border-border dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary text-lg"/><label for="birth_date">تاريخ الميلاد <span class="text-error">*</span></label></div><div class="form-input-group"><select id="gender" name="gender" class="form-input w-full p-4 rounded-lg bg-card dark:bg-card-dark border-2 border-border dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary text-lg appearance-none"><option value="" disabled selected hidden></option><option value="male">ذكر</option><option value="female">أنثى</option></select><label for="gender">الجنس <span class="text-error">*</span></label><span class="material-symbols-outlined absolute top-1/2 left-4 -translate-y-1/2 text-text-secondary dark:text-text-secondary-dark pointer-events-none">expand_more</span></div></div><div data-role-fields="student" class="space-y-6"><div class="form-input-group"><select id="halaqa" name="halaqa" class="form-input w-full p-4 rounded-lg bg-card dark:bg-card-dark border-2 border-border dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary text-lg appearance-none"><option value="" disabled selected hidden></option>{% for h in halaqas %}<option value="{{ h.id }}">{{ h.name }}</option>{% empty %}<option value="" disabled>لا توجد حلقات متاحة</option>{% endfor %}</select><label for="halaqa">الحلقة <span class="text-error">*</span></label><span class="material-symbols-outlined absolute top-1/2 left-4 -translate-y-1/2 text-text-secondary dark:text-text-secondary-dark pointer-events-none">expand_more</span></div><div class="form-input-group"><input id="guardian_phone" name="guardian_phone" type="tel" placeholder=" " class="form-input w-full p-4 rounded-lg bg-card dark:bg-card-dark border-2 border-border dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary text-lg"/><label for="guardian_phone">رقم جوال ولي الأمر (اختياري)</label></div></div><div data-role-fields="teacher" class="hidden space-y-6"><div class="form-input-group"><input id="institution" name="institution" type="text" placeholder=" " class="form-input w-full p-4 rounded-lg bg-card dark:bg-card-dark border-2 border-border dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary text-lg"/><label for="institution">المؤسسة / الجهة (اختياري)</label></div><div class="form-input-group"><textarea id="bio" name="bio" placeholder=" " rows="2" class="form-input w-full p-4 rounded-lg bg-card dark:bg-card-dark border-2 border-border dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary text-lg"></textarea><label for="bio">نبذة قصيرة (اختياري)</label></div><div><label class="text-sm font-medium text-text-secondary dark:text-text-secondary-dark">إرفاق شهادة أو إجازة (اختياري)</label><label for="certificate" class="mt-2 flex justify-center w-full h-32 px-6 pt-5 pb-6 border-2 border-border dark:border-border-dark border-dashed rounded-md cursor-pointer hover:border-primary dark:hover:border-primary-dark transition-colors"><div class="space-y-1 text-center"><svg class="mx-auto h-12 w-12 text-text-secondary/50 dark:text-text-secondary-dark/50" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg><div class="flex text-sm text-text-secondary dark:text-text-secondary-dark"><p class="pl-1">اختر ملفًا أو اسحبه وأفلته هنا</p></div><p id="file-name" class="text-xs text-primary dark:text-primary-dark"></p></div></label><input id="certificate" name="certificate" type="file" class="sr-only" accept=".pdf,.png,.jpg,.jpeg"></div></div><div class="flex justify-between pt-4"><button type="button" class="prev-btn w-auto bg-gray-200 dark:bg-gray-700 text-text-primary dark:text-text-primary-dark font-bold py-3 px-8 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">السابق</button><button type="button" class="next-btn w-auto bg-primary text-white font-bold py-3 px-8 rounded-lg hover:bg-primary-light transition-colors">التالي</button></div></div></div>
                    <div class="step absolute w-full" data-step="3"><div class="space-y-4 pt-2"><div><div class="form-input-group"><input id="password" name="password" type="password" placeholder=" " required class="form-input w-full p-4 rounded-lg bg-card dark:bg-card-dark border-2 border-border dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary text-lg"/><label for="password">كلمة المرور <span class="text-error">*</span></label><button type="button" id="togglePassword" class="absolute left-4 top-1/2 -translate-y-1/2 text-text-secondary dark:text-text-secondary-dark"><span class="material-symbols-outlined">visibility</span></button></div><div class="mt-2 px-1"><div class="h-1 w-full bg-border dark:bg-border-dark rounded-full overflow-hidden"><div id="password-strength-bar" class="h-1 transition-all duration-300"></div></div><p id="password-strength-text" class="text-xs mt-1"></p></div></div><div><div class="form-input-group"><input id="password2" name="password2" type="password" placeholder=" " required class="form-input w-full p-4 rounded-lg bg-card dark:bg-card-dark border-2 border-border dark:border-border-dark focus:outline-none focus:ring-0 focus:border-primary text-lg"/><label for="password2">تأكيد كلمة المرور <span class="text-error">*</span></label></div><p id="password-match-text" class="text-xs mt-1 mr-2 h-4 opacity-0 transition-opacity">كلمتا المرور غير متطابقتين</p></div><div id="teacher-note" class="hidden text-center text-sm p-3 bg-blue-50 text-blue-800 border border-blue-200 rounded-lg dark:bg-info/10 dark:text-info dark:border-info/20">سيتم مراجعة حسابك كـ "معلم" من قبل الإدارة قبل التفعيل.</div><div class="flex items-start pt-4"><input id="terms" name="terms" type="checkbox" required class="h-5 w-5 mt-1 text-primary focus:ring-primary/50 border-gray-300 rounded"/><label for="terms" class="mr-3 text-sm text-text-secondary dark:text-text-secondary-dark">أوافق على <a href="#" id="terms-link" class="font-bold text-primary hover:underline">الشروط والأحكام</a>.</label></div><div class="flex justify-between pt-4"><button type="button" class="prev-btn w-auto bg-gray-200 dark:bg-gray-700 text-text-primary dark:text-text-primary-dark font-bold py-3 px-8 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">السابق</button><button id="submit-btn" type="submit" class="w-auto bg-primary text-white font-bold py-3 px-8 rounded-lg hover:bg-primary-light transition-colors disabled:opacity-50 disabled:cursor-not-allowed">إنشاء الحساب</button></div></div></div>
                </form>
            </div>
            <div class="flex-shrink-0">
                <div class="mt-8 text-center"><p class="text-sm text-text-secondary dark:text-text-secondary-dark">لديك حساب بالفعل؟ <a href="{% url 'accounts:login' %}" class="font-bold text-primary hover:underline">تسجيل الدخول</a></p></div>
            </div>
        </div>
    </div>

    <div class="hidden lg:flex w-1/2 bg-gradient-to-tr from-primary/5 to-secondary/10 dark:from-primary/10 dark:to-secondary/20 items-center justify-center p-12 relative overflow-hidden">
        <div class="absolute inset-0 opacity-20" style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23386641\' fill-opacity=\'0.2\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
        <div class="text-center z-10 space-y-4">
            <h2 id="dynamic-title" class="text-4xl font-black text-primary dark:text-success leading-tight transition-opacity duration-500 opacity-0"></h2>
            <div id="typewriter-container" class="typewriter-container h-16">
                 <p id="typewriter-text" class="text-2xl text-text-secondary dark:text-text-secondary-dark max-w-md mx-auto transition-opacity duration-500 opacity-0"></p>
            </div>
        </div>
    </div>
</div>

<div id="terms-modal" class="modal fixed inset-0 z-50 p-4">
    <div class="modal-overlay fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm js-close-modal"></div>
    <div class="w-full h-full flex items-center justify-center">
        <div class="relative bg-card dark:bg-card-dark rounded-xl shadow-lifted w-full max-w-lg m-4">
            <div class="p-6 border-b border-border dark:border-border-dark flex justify-between items-center"><h2 class="text-xl font-bold">الشروط والأحكام</h2><button class="js-close-modal text-text-secondary dark:text-text-secondary-dark hover:text-text-primary dark:hover:text-text-primary-dark transition-colors"><span class="material-symbols-outlined">close</span></button></div>
            <div class="p-6 text-text-secondary dark:text-text-secondary-dark space-y-4 max-h-[60vh] overflow-y-auto"><p>هذا نص تجريبي للشروط والأحكام. يجب استبداله بالنص الفعلي الخاص بمنصتكم.</p><p>لوريم إيبسوم هو ببساطة نص شكلي (بمعنى أن الغاية هي الشكل وليس المحتوى) ويُستخدم في صناعات المطابع ودور النشر. كان لوريم إيبسوم ولايزال المعيار للنص الشكلي منذ القرن الخامس عشر عندما قامت مطبعة غير معروفة برص مجموعة من الأحرف بشكل عشوائي أخذتها من نص، لتكوّن كتيّب بمثابة دليل أو مرجع شكلي لهذه الأحرف.</p></div>
            <div class="p-4 bg-background dark:bg-background-dark/50 rounded-b-xl flex justify-end"><button class="js-close-modal bg-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-primary-light transition-colors">أوافق</button></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const formContainer = document.getElementById('form-container');
    const form = document.getElementById('registration-form');
    const steps = form.querySelectorAll('.step');
    const stepIndicators = document.querySelectorAll('.step-indicator');
    const submitBtn = document.getElementById('submit-btn');
    const teacherNote = document.getElementById('teacher-note');
    const certificateInput = document.getElementById('certificate');
    const fileNameDisplay = document.getElementById('file-name');
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const passwordInput = document.getElementById('password');
    const password2Input = document.getElementById('password2');
    const strengthBar = document.getElementById('password-strength-bar');
    const strengthText = document.getElementById('password-strength-text');
    const matchText = document.getElementById('password-match-text');
    const termsModal = document.getElementById('terms-modal');
    const dynamicTitle = document.getElementById('dynamic-title');
    const typewriterText = document.getElementById('typewriter-text');
    let passwordStrengthScore = 0;
    let typewriterTimeout;

    const inspirationalContent = [
        { title: "من وحي القرآن والسنة", quote: "خَيْرُكُمْ مَنْ تَعَلَّمَ القُرْآنَ وَعَلَّمَهُ" },
        { title: "اقرأ وارتقِ", quote: "فإن منزلتك عند آخر آية تقرؤها." },
        { title: "القرآن رفيقك", quote: "معنا يصبح الحفظ والمراجعة أسهل." }
    ];
    let contentIndex = 0;

    const updateUI = () => {
        if (currentStep === 2) {
            formContainer.classList.add('flex', 'flex-col', 'h-full', 'max-h-[95vh]');
        } else {
            formContainer.classList.remove('flex', 'flex-col', 'h-full', 'max-h-[95vh]');
        }
        stepIndicators.forEach(indicator => {
            const indicatorDiv = indicator.querySelector('div');
            const indicatorStep = parseInt(indicator.dataset.step);
            indicatorDiv.classList.remove('bg-primary', 'text-white', 'bg-gray-200', 'dark:bg-gray-700');
            indicatorDiv.innerHTML = indicatorStep;
            if (indicatorStep < currentStep) {
                indicatorDiv.classList.add('bg-primary', 'text-white');
                indicatorDiv.innerHTML = `<span class="material-symbols-outlined !text-xl">check</span>`;
            } else if (indicatorStep === currentStep) {
                indicatorDiv.classList.add('bg-primary', 'text-white');
            } else {
                indicatorDiv.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-text-secondary', 'dark:text-text-secondary-dark');
            }
        });
        let activeStepElement = null;
        steps.forEach(step => {
            if (parseInt(step.dataset.step) === currentStep) {
                step.classList.remove('anim-out');
                step.classList.add('active', 'anim-in');
                activeStepElement = step;
            } else {
                step.classList.remove('active', 'anim-in');
            }
        });
        if (activeStepElement) {
            const contentHeight = activeStepElement.firstElementChild.scrollHeight;
            form.style.minHeight = `${contentHeight}px`;
        }
    };

    const validateStep = (stepNumber) => {
        const stepDiv = form.querySelector(`.step[data-step="${stepNumber}"]`);
        const inputs = stepDiv.querySelectorAll('input[required], select[required]');
        for (let input of inputs) {
            if (input.closest('[data-role-fields]') && input.closest('[data-role-fields]').classList.contains('hidden')) { continue; }
            if (!input.checkValidity()) { input.reportValidity(); return false; }
        }
        return true;
    };
    
    document.querySelectorAll('.next-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (!validateStep(currentStep)) return;
            if (currentStep < 3) {
                form.querySelector(`.step.active`)?.classList.add('anim-out');
                setTimeout(() => { currentStep++; updateUI(); }, 300);
            }
        });
    });

    document.querySelectorAll('.prev-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (currentStep > 1) {
                form.querySelector(`.step.active`)?.classList.add('anim-out');
                setTimeout(() => { currentStep--; updateUI(); }, 300);
            }
        });
    });

    const roleSelector = document.getElementById('role-selector');
    const roleButtons = roleSelector.querySelectorAll('button');
    const roleInput = document.getElementById('register-role');

    const setRole = (role) => {
        roleInput.value = role;
        roleButtons.forEach(btn => {
            const isActive = btn.dataset.role === role;
            btn.classList.toggle('bg-card', isActive); btn.classList.toggle('dark:bg-card-dark', isActive);
            btn.classList.toggle('text-primary', isActive); btn.classList.toggle('dark:text-primary-dark', isActive);
            btn.classList.toggle('shadow-sm', isActive);
        });
        document.querySelectorAll('[data-role-fields]').forEach(fieldSet => {
            const isVisible = fieldSet.dataset.roleFields === role;
            fieldSet.classList.toggle('hidden', !isVisible);
            fieldSet.querySelectorAll('input, select, textarea').forEach(input => {
                const isStudentRequired = ['halaqa'].includes(input.name);
                if (role === 'student') {
                    input.required = isStudentRequired;
                } else {
                    input.required = false;
                }
            });
        });
        const isTeacher = role === 'teacher';
        submitBtn.textContent = isTeacher ? 'إرسال طلب التسجيل' : 'إنشاء الحساب';
        teacherNote.classList.toggle('hidden', !isTeacher);
        setTimeout(() => updateUI(), 50); 
    };
    
    setRole('student');
    roleButtons.forEach(btn => btn.addEventListener('click', () => setRole(btn.dataset.role)));
    
    certificateInput.addEventListener('change', () => {
        fileNameDisplay.textContent = certificateInput.files.length > 0 ? certificateInput.files[0].name : '';
    });

    const togglePassword = document.getElementById('togglePassword');
    if (togglePassword) {
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            password2Input.setAttribute('type', type);
            this.querySelector('span').textContent = type === 'password' ? 'visibility' : 'visibility_off';
        });
    }

    const applyTheme = (theme) => {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            if(themeIcon) themeIcon.textContent = 'light_mode';
        } else {
            document.documentElement.classList.remove('dark');
            if(themeIcon) themeIcon.textContent = 'dark_mode';
        }
    };
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);
    themeToggle?.addEventListener('click', () => {
        const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    });

    const checkPasswords = () => {
        const pass1 = passwordInput.value;
        const pass2 = password2Input.value;
        let passwordsMatch = false;

        if (pass1.length > 0 || pass2.length > 0) {
            matchText.classList.remove('opacity-0');
            if (pass1 === pass2 && pass1.length > 0) {
                matchText.textContent = 'كلمتا المرور متطابقتان';
                matchText.className = 'text-xs mt-1 mr-2 h-4 transition-opacity text-primary dark:text-success';
                passwordsMatch = true;
            } else {
                matchText.textContent = 'كلمتا المرور غير متطابقتين';
                matchText.className = 'text-xs mt-1 mr-2 h-4 transition-opacity text-error';
                passwordsMatch = false;
            }
        } else {
            matchText.classList.add('opacity-0');
            passwordsMatch = true;
        }
        submitBtn.disabled = !(passwordStrengthScore >= 3 && passwordsMatch);
    };

    passwordInput.addEventListener('input', function() {
        const password = this.value;
        let score = 0;
        if (password.length >= 8) score++;
        if (/[A-Z]/.test(password)) score++;
        if (/[a-z]/.test(password)) score++;
        if (/[0-9]/.test(password)) score++;
        if (/[^A-Za-z0-9]/.test(password)) score++;
        passwordStrengthScore = score;

        strengthBar.className = 'h-1 transition-all duration-300';
        
        let strength = { width: '0%', color: '', text: '', textColor: '' };
        switch (score) {
            case 1: case 2: strength = { width: '25%', color: 'bg-error', text: 'ضعيفة', textColor: 'text-error'}; break;
            case 3: strength = { width: '50%', color: 'bg-warning', text: 'متوسطة', textColor: 'text-warning'}; break;
            case 4: strength = { width: '75%', color: 'bg-primary-light', text: 'قوية', textColor: 'text-primary-light'}; break;
            case 5: strength = { width: '100%', color: 'bg-primary', text: 'قوية جدًا', textColor: 'text-primary'}; break;
        }
        
        if (password.length === 0) {
            strengthBar.style.width = '0%';
            strengthText.textContent = '';
        } else {
            strengthBar.style.width = strength.width;
            strengthBar.classList.add(strength.color);
            strengthText.textContent = `قوة كلمة المرور: ${strength.text}`;
            strengthText.className = `text-xs mt-1 ${strength.textColor}`;
        }
        checkPasswords();
    });
    password2Input.addEventListener('input', checkPasswords);

    document.getElementById('terms-link').addEventListener('click', (e) => {
        e.preventDefault(); termsModal.classList.add('is-visible');
    });
    termsModal.querySelectorAll('.js-close-modal').forEach(btn => {
        btn.addEventListener('click', () => {
            termsModal.classList.remove('is-visible');
            document.getElementById('terms').checked = true;
        });
    });
    
    function runTypewriter() {
        clearTimeout(typewriterTimeout);
        const content = inspirationalContent[contentIndex];
        
        dynamicTitle.classList.add('opacity-0', 'animate-fade-out');
        typewriterText.classList.add('opacity-0', 'animate-fade-out');
        typewriterText.classList.remove('typewriter-text');

        setTimeout(() => {
            dynamicTitle.textContent = content.title;
            typewriterText.textContent = '';
            
            dynamicTitle.classList.remove('opacity-0', 'animate-fade-out');
            typewriterText.classList.remove('opacity-0', 'animate-fade-out');
            dynamicTitle.classList.add('animate-fade-in');
            
            let i = 0;
            const typingInterval = setInterval(() => {
                if (i < content.quote.length) {
                    typewriterText.textContent += content.quote.charAt(i);
                    i++;
                } else {
                    clearInterval(typingInterval);
                    typewriterText.classList.add('typewriter-text'); // Add border after typing
                    typewriterTimeout = setTimeout(() => {
                        contentIndex = (contentIndex + 1) % inspirationalContent.length;
                        runTypewriter();
                    }, 10000); // 15-second pause
                }
            }, 60); 
        }, 500); 
    }
    
    form.addEventListener('submit', function(event) {
        event.preventDefault(); 
        if (!validateStep(currentStep)) return;
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>جاري الإنشاء...</span>`;
        const formData = new FormData(form);
        const loginUrl = "{% url 'accounts:login' %}";
        fetch(form.action, { method: 'POST', body: formData, headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken'), 'X-Requested-With': 'XMLHttpRequest' }})
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const config = data.role === 'teacher' 
                    ? { icon: 'info', title: 'طلبك قيد المراجعة', text: 'شكرًا لتسجيلك! سيتم مراجعة حسابك كمعلم من قبل الإدارة وسيتم إعلامك عند التفعيل.' }
                    : { icon: 'success', title: 'تم إنشاء الحساب بنجاح!', text: 'مرحبًا بك في منصة آية. يمكنك الآن تسجيل الدخول.' };
                Swal.fire({ ...config, confirmButtonText: 'حسنًا، الانتقال لتسجيل الدخول', confirmButtonColor: '#386641' })
                .then(() => { window.location.href = loginUrl; });
            } else {
                Swal.fire({ icon: 'error', title: 'حدث خطأ', html: data.message || 'الرجاء التأكد من صحة البيانات المدخلة.', confirmButtonColor: '#e63946' });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({ icon: 'error', title: 'خطأ في الاتصال', text: 'حدث خطأ غير متوقع. الرجاء المحاولة مرة أخرى.', confirmButtonColor: '#e63946'});
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = 'إنشاء الحساب';
        });
    });

    updateUI();
    runTypewriter();
});
</script>

</body>
</html>