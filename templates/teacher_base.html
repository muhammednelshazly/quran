{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>{% block title %}منصة آية{% endblock %}</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: { "primary": "#386641", "secondary": "#6A994E", "background": "#F7F9FC", "card": "#FFFFFF", "text-primary": "#212529", "text-secondary": "#6C757D", "success": "#A7C957" },
              fontFamily: { "display": ["Cairo", "sans-serif"] },
              borderRadius: { "lg": "0.75rem" },
              boxShadow: { "subtle": "0 4px 6px -1px rgba(0, 0, 0, 0.05)", "lifted": "0 10px 15px -3px rgba(0, 0, 0, 0.1)" }
            },
          },
        }
    </script>
    
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
        .modal { visibility: hidden; opacity: 0; transition: visibility 0s 0.3s, opacity 0.3s ease-in-out; }
        .modal.is-visible { visibility: visible; opacity: 1; transition: opacity 0.3s ease-in-out; }
        .modal-content { transform: scale(0.95); opacity: 0; transition: all 0.3s ease-in-out; }
        .modal.is-visible .modal-content { transform: scale(1); opacity: 1; }
        .modal-open { overflow: hidden; }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>

<body class="bg-background font-display text-text-primary">
    <div class="flex h-screen">
        <aside class="fixed top-0 right-0 h-full w-64 bg-card p-6 flex flex-col justify-between shadow-subtle z-20">
            <div>
                <div class="flex items-center gap-3 mb-10">
                    <div class="bg-primary p-2 rounded-lg">
                        <svg class="text-white" fill="none" height="24" viewBox="0 0 48 48" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M44 4H30.6666V17.3334H17.3334V30.6666H4V44H44V4Z" fill="currentColor"></path></svg>
                    </div>
                    <h2 class="text-xl font-bold text-text-primary">منصة آية</h2>
                </div>
                <nav class="flex flex-col gap-4">
                    <a href="{% url 'accounts:teacher_dashboard' %}" class="flex items-center gap-3 px-4 py-2 rounded-lg {% if request.resolver_match.url_name == 'teacher_dashboard' %}bg-primary/10 text-primary{% else %}text-text-secondary hover:bg-primary/10 hover:text-primary{% endif %} transition-colors">
                        <span class="material-symbols-outlined">home</span>
                        <span>الرئيسية</span>
                    </a>
                    <a href="{% url 'accounts:teacher_halaqat' %}" class="flex items-center gap-3 px-4 py-2 rounded-lg text-text-secondary hover:bg-primary/10 hover:text-primary transition-colors">
                        <span class="material-symbols-outlined">groups</span>
                        <span>الحلقات</span>
                    </a>
                    <a href="{% url 'accounts:teacher_students' %}" class="flex items-center gap-3 px-4 py-2 rounded-lg {% if request.resolver_match.url_name == 'teacher_students' %}bg-primary/10 text-primary{% else %}text-text-secondary hover:bg-primary/10 hover:text-primary{% endif %} transition-colors">
                        <span class="material-symbols-outlined">school</span>
                        <span>الطلاب</span>
                    </a>
                </nav>
            </div>
            {% if user.is_authenticated %}
            <div class="flex items-center gap-3 p-4 bg-background rounded-lg">
                <img src="{{ user.profile.avatar_url }}" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
                <div>
                    <p class="font-bold text-sm text-text-primary">{{ user.username }}</p>
                    <p class="text-xs text-text-secondary">{{ user.profile.get_role_display }}</p>
                </div>
                <a href="{% url 'accounts:logout' %}" class="material-symbols-outlined mr-auto text-text-secondary hover:text-primary transition-colors" title="تسجيل الخروج">logout</a>
            </div>
            {% endif %}
        </aside>
        
        <div class="flex-1 mr-64 flex flex-col overflow-hidden">
            <main class="h-full overflow-y-auto px-6 pt-12 lg:px-8 lg:pt-16">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    {% block extra_js %}
    <script>
        // =================================================================
        // == دوال عامة ستكون متاحة في جميع صفحات لوحة تحكم المعلم ==
        // =================================================================
        let activeModal = null;
        const body = document.body;

        const openModal = (modalElement) => {
            if (!modalElement) return;
            activeModal = modalElement;
            activeModal.classList.add('is-visible');
            body.classList.add('modal-open');
        };

        const closeModal = () => {
            if (!activeModal) return;
            const form = activeModal.querySelector('form');
            if(form) form.reset();
            activeModal.classList.remove('is-visible');
            body.classList.remove('modal-open');
            activeModal = null;
        };

        const loadSurahsForHalaqa = async (halaqaId, modalElement) => {
            const surahSelect = modalElement.querySelector('#surah-select');
            if (!surahSelect) return;
            
            surahSelect.innerHTML = '<option value="">جاري تحميل السور...</option>';
            surahSelect.disabled = true;
            try {
                const response = await fetch(`/accounts/api/halaqa/${halaqaId}/surahs/`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                surahSelect.innerHTML = '<option value="" disabled selected>اختر السورة</option>';
                data.surahs.forEach(surah => {
                    const option = new Option(surah.name, surah.id);
                    surahSelect.add(option);
                });
                surahSelect.disabled = false;
            } catch (error) {
                console.error('Failed to load surahs:', error);
                surahSelect.innerHTML = '<option value="">فشل تحميل السور</option>';
            }
        };
        
        // ربط أحداث الإغلاق العامة
        document.addEventListener('click', function(event) {
            if (event.target.closest('.js-close-modal')) {
                closeModal();
            }
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && activeModal) {
                closeModal();
            }
        });
    </script>
    {% endblock %}
</body>
</html>