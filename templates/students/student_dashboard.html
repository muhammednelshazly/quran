{% load static custom_filters %}
<!DOCTYPE html>
<html dir="rtl" lang="ar" class="">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>منصة آية - لوحة تحكم الطالب</title>

    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#386641", "secondary": "#6A994E", "success": "#A7C957", "background": "#F7F9FC",
                        "card": "#FFFFFF", "text-primary": "#212529", "text-secondary": "#6C757D",
                        "border-color": "#E5E7EB", "danger": "#e63946", "warning": "#f59e0b", "info": "#0ea5e9",
                        "background-dark": "#111827", "card-dark": "#1F2937", "text-primary-dark": "#F9FAFB",
                        "text-secondary-dark": "#9CA3AF", "border-color-dark": "#374151",
                    },
                    fontFamily: { display: ["Cairo", "sans-serif"] },
                    boxShadow: {
                        subtle: "0 4px 12px -4px rgba(0, 0, 0, 0.05)",
                        lifted: "0 10px 20px -5px rgba(0, 0, 0, 0.07)",
                    },
                    keyframes: {
                        'fade-in-up': {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                    },
                    animation: {
                        'fade-in-up': 'fade-in-up 0.5s ease-out',
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24 }
        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .details-content.open { max-height: 500px; transition: max-height 0.5s ease-in-out; }
        .rotate-180 { transform: rotate(180deg); }
        .animated-card { opacity: 0; animation: fade-in-up 0.5s ease-out forwards; }
        .animate-delay-100 { animation-delay: 100ms; } .animate-delay-200 { animation-delay: 200ms; }
        .animate-delay-300 { animation-delay: 300ms; } .animate-delay-400 { animation-delay: 400ms; }
        .tab-button, .task-filter-btn {
            padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 700; border-radius: 0.5rem;
            transition: all 0.2s ease-in-out; color: #6C757D;
        }
        .dark .tab-button, .dark .task-filter-btn { color: #9CA3AF; }
        .tab-button.active, .task-filter-btn.active {
            color: #386641; background-color: #FFFFFF; box-shadow: 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .dark .tab-button.active, .dark .task-filter-btn.active { color: #A7C957; background-color: #1F2937; }
        [data-tab-content] { display: none; }
        [data-tab-content].active { display: block; }
    </style>
</head>

<body class="bg-background dark:bg-background-dark font-display text-text-primary dark:text-text-primary-dark antialiased">
<div class="min-h-screen">
    <header class="sticky top-0 z-40 bg-card/80 dark:bg-card-dark/80 backdrop-blur-sm border-b border-border-color dark:border-border-color-dark">
        <div class="mx-auto flex h-20 items-center justify-between px-4 sm:px-6 lg:px-8">
            <div class="flex items-center gap-4">
                <button id="profile-button" class="cursor-pointer">
                    <img src="{{ profile.avatar_url }}" alt="صورة الحساب" class="h-12 w-12 rounded-full border-2 border-primary object-cover transition-transform hover:scale-105">
                </button>
                <div>
                    <h1 class="font-bold text-text-primary dark:text-text-primary-dark">مرحبًا، {{ user.username }}</h1>
                    <div class="flex items-center gap-2 text-sm text-text-secondary dark:text-text-secondary-dark">
                        <span class="material-symbols-outlined text-base">group</span>
                        <span>{{ profile.halaqa|default:"غير مسجل في حلقة" }}</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="theme-toggle" class="rounded-full p-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="تغيير المظهر">
                    <span class="material-symbols-outlined text-text-secondary dark:text-text-secondary-dark" id="theme-icon"></span>
                </button>
                <a href="{% url 'accounts:student_settings' %}" class="rounded-full p-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="الإعدادات">
                    <span class="material-symbols-outlined text-text-secondary dark:text-text-secondary-dark">settings</span>
                </a>
                <form method="post" action="{% url 'accounts:logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="flex items-center gap-2 rounded-lg bg-danger/10 py-2 px-4 text-sm font-bold text-danger hover:bg-danger/20 transition-colors">
                        <span class="material-symbols-outlined">logout</span><span class="hidden sm:inline">خروج</span>
                    </button>
                </form>
            </div>
        </div>
    </header>

    <main class="py-8">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <section class="animated-card animate-delay-100">
                        <h3 class="text-xl font-bold mb-4">تقدمك هذا الأسبوع</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-card dark:bg-card-dark p-6 rounded-xl shadow-subtle border border-border-color dark:border-border-color-dark flex items-center gap-6 transition-all duration-300 hover:shadow-lifted hover:-translate-y-1">
                                <div class="relative w-24 h-24 flex-shrink-0">
                                    <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36"><circle cx="18" cy="18" r="15.915" class="stroke-current text-gray-200 dark:text-gray-700" stroke-width="3" fill="none"></circle><circle cx="18" cy="18" r="15.915" class="stroke-current text-primary dark:text-success" stroke-width="3" fill="none" stroke-dasharray="{{ weekly_hifdh_score }}, 100" stroke-linecap="round"></circle></svg>
                                    <div class="absolute inset-0 flex items-center justify-center text-xl font-extrabold">{{ weekly_hifdh_score }}<span class="text-sm">%</span></div>
                                </div>
                                <div><h4 class="font-bold text-lg">الحفظ الجديد</h4><p class="text-text-secondary dark:text-text-secondary-dark text-sm mt-1">متوسط الدقة في التسميعات.</p></div>
                            </div>
                            <div class="bg-card dark:bg-card-dark p-6 rounded-xl shadow-subtle border border-border-color dark:border-border-color-dark flex items-center gap-6 transition-all duration-300 hover:shadow-lifted hover:-translate-y-1">
                                <div class="relative w-24 h-24 flex-shrink-0">
                                    <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36"><circle cx="18" cy="18" r="15.915" class="stroke-current text-gray-200 dark:text-gray-700" stroke-width="3" fill="none"></circle><circle cx="18" cy="18" r="15.915" class="stroke-current text-secondary" stroke-width="3" fill="none" stroke-dasharray="{{ weekly_review_score }}, 100" stroke-linecap="round"></circle></svg>
                                    <div class="absolute inset-0 flex items-center justify-center text-xl font-extrabold">{{ weekly_review_score }}<span class="text-sm">%</span></div>
                                </div>
                                <div><h4 class="font-bold text-lg">المراجعة</h4><p class="text-text-secondary dark:text-text-secondary-dark text-sm mt-1">متوسط الدقة في المراجعات.</p></div>
                            </div>
                        </div>
                    </section>
                    
                    <section class="animated-card animate-delay-200">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                            <h3 class="text-xl font-bold">مهامك الدراسية</h3>
                            <div class="flex items-center rounded-lg bg-background dark:bg-background-dark p-1 shadow-inner">
                                <button class="task-filter-btn active" data-filter="all">الكل</button>
                                <button class="task-filter-btn" data-filter="recitation">تسميع</button>
                                <button class="task-filter-btn" data-filter="review">مراجعة</button>
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row items-center justify-between mb-4 gap-2">
                            <div class="flex items-center rounded-lg bg-background dark:bg-background-dark p-1 shadow-inner">
                                <button class="tab-button active" data-tab-target="#pending">مطلوبة</button>
                                <button class="tab-button" data-tab-target="#submitted">قيد المراجعة</button>
                                <button class="tab-button" data-tab-target="#graded">مكتملة</button>
                            </div>

                            <div class="relative" id="sort-dropdown-container">
                                <button id="sort-button" class="flex items-center gap-2 text-sm font-bold text-text-secondary dark:text-text-secondary-dark hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md py-2 px-3 transition-colors">
                                    <span class="material-symbols-outlined text-base">filter_list</span>
                                    <span id="sort-label">الأحدث أولاً</span>
                                    <span class="material-symbols-outlined text-base">expand_more</span>
                                </button>
                                <div id="sort-menu" class="hidden absolute left-0 mt-2 w-48 bg-card dark:bg-card-dark rounded-lg shadow-lifted border border-border-color dark:border-border-color-dark z-10">
                                    <a href="#" class="sort-option block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-sort="newest">الأحدث أولاً</a>
                                    <a href="#" class="sort-option block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-sort="oldest">الأقدم أولاً</a>
                                    <a href="#" class="sort-option block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-sort="deadline">الأقرب للموعد النهائي</a>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div id="pending" class="tab-content active space-y-3" data-tab-content>
                                {% for task in pending_tasks %}{% include 'students/partials/_task_item.html' with task=task sub=task.sub %}{% empty %}<div class="empty-state text-center text-text-secondary dark:text-text-secondary-dark p-6 bg-card dark:bg-card-dark rounded-xl border border-dashed"><p>لا توجد مهام مطلوبة حاليًا. عمل رائع!</p></div>{% endfor %}
                            </div>
                            <div id="submitted" class="tab-content space-y-3" data-tab-content>
                                {% for task in submitted_tasks %}{% include 'students/partials/_task_item.html' with task=task sub=task.sub %}{% empty %}<div class="empty-state text-center text-text-secondary dark:text-text-secondary-dark p-6 bg-card dark:bg-card-dark rounded-xl border border-dashed"><p>لا توجد مهام تنتظر المراجعة.</p></div>{% endfor %}
                            </div>
                            <div id="graded" class="tab-content space-y-3" data-tab-content>
                                {% for task in graded_tasks %}{% include 'students/partials/_task_item.html' with task=task sub=task.sub %}{% empty %}<div class="empty-state text-center text-text-secondary dark:text-text-secondary-dark p-6 bg-card dark:bg-card-dark rounded-xl border border-dashed"><p>لم يتم تقييم أي مهام بعد.</p></div>{% endfor %}
                            </div>
                        </div>
                    </section>
                </div>
                
                <div class="lg:col-span-1 space-y-8">
                    <section class="animated-card animate-delay-300">
                        <h3 class="text-xl font-bold mb-4">إحصائيات عامة</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-card dark:bg-card-dark p-4 rounded-xl shadow-subtle border border-border-color dark:border-border-color-dark transition-all duration-300 hover:shadow-lifted hover:-translate-y-1">
                                <span class="material-symbols-outlined text-info text-3xl">pending_actions</span>
                                <p id="pending-tasks-count-stat" class="text-2xl font-extrabold mt-2">{{ pending_tasks_count }}</p>
                                <p class="text-sm font-medium text-text-secondary dark:text-text-secondary-dark">مهام مطلوبة</p>
                            </div>
                            <div class="bg-card dark:bg-card-dark p-4 rounded-xl shadow-subtle border border-border-color dark:border-border-color-dark transition-all duration-300 hover:shadow-lifted hover:-translate-y-1">
                                <span class="material-symbols-outlined text-secondary text-3xl">military_tech</span>
                                <p class="text-2xl font-extrabold mt-2">{{ accuracy_pct }}<span class="text-lg">%</span></p>
                                <p class="text-sm font-medium text-text-secondary dark:text-text-secondary-dark">متوسط الأداء</p>
                            </div>
                            <div class="bg-card dark:bg-card-dark p-4 rounded-xl shadow-subtle border border-border-color dark:border-border-color-dark transition-all duration-300 hover:shadow-lifted hover:-translate-y-1">
                                <span class="material-symbols-outlined text-primary dark:text-success text-3xl">checklist</span>
                                <p class="text-2xl font-extrabold mt-2">{{ presence_pct }}<span class="text-lg">%</span></p>
                                <p class="text-sm font-medium text-text-secondary dark:text-text-secondary-dark">نسبة الحضور</p>
                            </div>
                             <div class="bg-card dark:bg-card-dark p-4 rounded-xl shadow-subtle border border-border-color dark:border-border-color-dark transition-all duration-300 hover:shadow-lifted hover:-translate-y-1">
                                <span class="material-symbols-outlined text-warning text-3xl">menu_book</span>
                                <p class="text-2xl font-extrabold mt-2">{{ ayah_count }}</p>
                                <p class="text-sm font-medium text-text-secondary dark:text-text-secondary-dark">آية محفوظة</p>
                            </div>
                        </div>
                    </section>
                    <section class="animated-card animate-delay-400">
                        <h3 class="text-xl font-bold mb-4">الحضور الأسبوعي</h3>
                        <div class="bg-card dark:bg-card-dark p-4 rounded-xl shadow-subtle border border-border-color dark:border-border-color-dark">
                            <div class="flex items-center justify-between">
                                {% for day in week_attendance %}
                                <div class="flex flex-col items-center gap-2 text-center w-12">
                                    <span class="text-xs font-bold text-text-secondary dark:text-text-secondary-dark">
                                        {% with wd=day.date|date:"w" %}{% if wd == '6' %}س{% elif wd == '0' %}أ{% elif wd == '1' %}إ{% elif wd == '2' %}ث{% elif wd == '3' %}أ{% elif wd == '4' %}خ{% elif wd == '5' %}ج{% endif %}{% endwith %}
                                    </span>
                                    {% if day.status == "present" %}<div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center" title="حاضر"><span class="material-symbols-outlined text-white text-base">check</span></div>
                                    {% elif day.status == "absent" %}<div class="w-8 h-8 rounded-full bg-danger flex items-center justify-center" title="غائب"><span class="material-symbols-outlined text-white text-base">close</span></div>
                                    {% else %}<div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700" title="لم يسجل"></div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="profile-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-opacity duration-300 opacity-0">
    <div id="profile-modal-content" class="bg-card dark:bg-card-dark rounded-2xl shadow-lifted w-full max-w-sm p-8 text-center relative transform transition-all duration-300 scale-95 opacity-0">
        <button id="profile-close-button" class="absolute top-4 right-4 rounded-full p-1.5 text-text-secondary dark:text-text-secondary-dark hover:bg-gray-100 dark:hover:bg-gray-700">
            <span class="material-symbols-outlined">close</span>
        </button>
        <img src="{{ profile.avatar_url }}" alt="صورة الحساب" class="h-28 w-28 rounded-full border-4 border-primary object-cover mx-auto -mt-20 mb-4">
        <h2 class="text-2xl font-bold">{{ user.get_full_name|default:user.username }}</h2>
        <p class="text-text-secondary dark:text-text-secondary-dark">@{{ user.username }}</p>

        <div class="text-right space-y-4 mt-6 border-t border-border-color dark:border-border-color-dark pt-6">
            <div class="flex items-center justify-between text-sm">
                <span class="font-semibold text-text-secondary dark:text-text-secondary-dark">الحلقة:</span>
                <span class="font-bold">{{ profile.halaqa|default:"-" }}</span>
            </div>
            <div class="flex items-center justify-between text-sm">
                <span class="font-semibold text-text-secondary dark:text-text-secondary-dark">المعلم:</span>
                <span class="font-bold">{{ halaqa_teacher_name }}</span>
            </div>
            <div class="flex items-center justify-between text-sm">
                <span class="font-semibold text-text-secondary dark:text-text-secondary-dark">تاريخ الانضمام:</span>
                <span class="font-bold">{{ user.date_joined|date:"j F Y" }}</span>
            </div>
        </div>
    </div>
</div>

<div id="rec-modal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-card dark:bg-card-dark rounded-xl shadow-lifted w-full max-w-md p-8 text-center relative animate-fade-in-up" style="animation-duration: 0.3s;">
        <button id="rec-close" class="absolute top-4 left-4 rounded-full p-1.5 text-text-secondary dark:text-text-secondary-dark hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="إغلاق">
            <span class="material-symbols-outlined">close</span>
        </button>
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-text-primary dark:text-text-primary-dark mb-2" id="rec-title">تسجيل التلاوة</h2>
            <p class="text-text-secondary dark:text-text-secondary-dark">اضغط على زر البدء عندما تكون مستعدًا.</p>
        </div>
        <div class="relative mb-6">
            <div class="w-24 h-24 bg-primary/10 dark:bg-success/20 rounded-full mx-auto flex items-center justify-center">
                <div class="w-16 h-16 bg-primary/20 dark:bg-success/30 rounded-full flex items-center justify-center">
                    <span class="material-symbols-outlined text-4xl text-primary dark:text-success" id="mic-icon">mic</span>
                </div>
            </div>
            <p id="rec-timer" class="mt-3 text-sm text-text-secondary dark:text-text-secondary-dark">00:00</p>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button id="rec-start" class="col-span-2 flex items-center justify-center gap-2 w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-primary/90 transition">
                <span class="material-symbols-outlined">fiber_manual_record</span><span>بدء التسجيل</span>
            </button>
            <button id="rec-stop" class="col-span-2 flex items-center justify-center gap-2 w-full bg-danger/10 text-danger font-bold py-3 px-4 rounded-lg hover:bg-danger/20 transition opacity-50 cursor-not-allowed" disabled>
                <span class="material-symbols-outlined">stop_circle</span><span>إيقاف التسجيل</span>
            </button>
        </div>
        <audio id="rec-audio" class="w-full mb-4" controls hidden></audio>
        <div class="flex items-center justify-between gap-4">
            <button id="rec-retry" class="flex items-center justify-center gap-2 w-full bg-gray-100 dark:bg-gray-700 text-text-primary dark:text-text-primary-dark font-bold py-3 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition" disabled>
                <span class="material-symbols-outlined">replay</span><span>إعادة المحاولة</span>
            </button>
            <button id="rec-submit" class="w-full bg-primary/10 dark:bg-success/20 text-primary dark:text-success font-bold py-3 px-4 rounded-lg hover:bg-primary/20 dark:hover:bg-success/30 transition opacity-50 cursor-not-allowed" disabled>
                <span>تسليم</span>
            </button>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Theme Toggle Logic ---
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const applyTheme = (theme) => {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            if(themeIcon) themeIcon.textContent = 'light_mode';
        } else {
            document.documentElement.classList.remove('dark');
            if(themeIcon) themeIcon.textContent = 'dark_mode';
        }
    };
    const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(savedTheme);
    themeToggle?.addEventListener('click', () => {
        const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    });

    // --- Tabs Logic ---
    document.querySelectorAll(".tab-button").forEach(button => {
        button.addEventListener("click", () => {
            document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
            button.classList.add("active");
            document.querySelectorAll("[data-tab-content]").forEach(content => {
                content.classList.remove("active");
                content.style.display = 'none';
            });
            const activeTab = document.querySelector(button.dataset.tabTarget);
            activeTab.classList.add("active");
            activeTab.style.display = 'block';
        });
    });

    // --- Task Type Filter Logic ---
    document.querySelectorAll('.task-filter-btn').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.task-filter-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const filter = button.dataset.filter;
            document.querySelectorAll('.task-item').forEach(item => {
                item.style.display = (filter === 'all' || item.dataset.taskType === filter) ? '' : 'none';
            });
        });
    });

    // --- Task Details Expansion (using event delegation) ---
    document.body.addEventListener('click', event => {
        if (event.target.closest('.open-recitation')) return;
        const header = event.target.closest('.task-header');
        if (header) {
            const details = header.nextElementSibling;
            if (details && details.classList.contains('details-content')) {
                details.classList.toggle('open');
                header.querySelector('.arrow-icon')?.classList.toggle('rotate-180');
            }
        }
    });

    // --- Profile Modal Logic ---
    const profileButton = document.getElementById('profile-button');
    const profileModal = document.getElementById('profile-modal');
    const profileModalContent = document.getElementById('profile-modal-content');
    const profileCloseButton = document.getElementById('profile-close-button');
    const openProfileModal = () => {
        profileModal.classList.remove('hidden', 'opacity-0');
        profileModal.classList.add('flex');
        setTimeout(() => {
            profileModalContent.classList.remove('scale-95', 'opacity-0');
        }, 10);
    };
    const closeProfileModal = () => {
        profileModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            profileModal.classList.add('hidden', 'opacity-0');
            profileModal.classList.remove('flex');
        }, 300);
    };
    profileButton?.addEventListener('click', openProfileModal);
    profileCloseButton?.addEventListener('click', closeProfileModal);
    profileModal?.addEventListener('click', (e) => { if (e.target === profileModal) closeProfileModal(); });

    // ========= START: Sorting Dropdown Logic =========
    const sortButton = document.getElementById('sort-button');
    const sortMenu = document.getElementById('sort-menu');
    const sortLabel = document.getElementById('sort-label');

    sortButton?.addEventListener('click', (e) => {
        e.stopPropagation();
        sortMenu.classList.toggle('hidden');
    });

    document.addEventListener('click', () => {
        sortMenu?.classList.add('hidden');
    });

    document.querySelectorAll('.sort-option').forEach(option => {
        option.addEventListener('click', (e) => {
            e.preventDefault();
            const sortType = e.target.dataset.sort;
            sortLabel.textContent = e.target.textContent;
            const activeTabContent = document.querySelector('.tab-content.active');
            if (!activeTabContent) return;

            const tasks = Array.from(activeTabContent.querySelectorAll('.task-item'));
            
            tasks.sort((a, b) => {
                let valA, valB;
                switch(sortType) {
                    case 'newest':
                        valA = a.dataset.createdAt; valB = b.dataset.createdAt;
                        return valB.localeCompare(valA); // B vs A for descending
                    case 'oldest':
                        valA = a.dataset.createdAt; valB = b.dataset.createdAt;
                        return valA.localeCompare(valB); // A vs B for ascending
                    case 'deadline':
                        valA = a.dataset.deadline || '9999-12-31T23:59:59+00:00';
                        valB = b.dataset.deadline || '9999-12-31T23:59:59+00:00';
                        return valA.localeCompare(valB); // A vs B for ascending
                    default:
                        return 0;
                }
            });

            // Re-append sorted tasks to the DOM
            tasks.forEach(task => activeTabContent.appendChild(task));
        });
    });
    // ========= END: Sorting Dropdown Logic =========
    
    // --- Recording Modal & AJAX Submission ---
    const getCookie = name => { let c = `; ${document.cookie}`.split(`; ${name}=`); if (c.length === 2) return c.pop().split(';').shift(); };
    const modal = document.getElementById('rec-modal');
    const recElements = {
        title: document.getElementById('rec-title'),
        start: document.getElementById('rec-start'),
        stop: document.getElementById('rec-stop'),
        retry: document.getElementById('rec-retry'),
        submit: document.getElementById('rec-submit'),
        audio: document.getElementById('rec-audio'),
        timer: document.getElementById('rec-timer'),
        micIcon: document.getElementById('mic-icon'),
        close: document.getElementById('rec-close'),
    };
    
    let currentTaskInfo = { url: null, id: null };
    let mediaRecorder, chunks = [], timerInt, seconds = 0;

    const formatTime = s => `${String(Math.floor(s / 60)).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;

    const openModal = (title, submitUrl, taskId) => {
        recElements.title.textContent = title || "تسجيل التلاوة";
        currentTaskInfo = { url: submitUrl, id: taskId };
        recElements.audio.hidden = true; recElements.audio.src = "";
        recElements.retry.disabled = true;
        recElements.submit.disabled = true; recElements.submit.classList.add('opacity-50', 'cursor-not-allowed');
        recElements.stop.disabled = true; recElements.stop.classList.add('opacity-50', 'cursor-not-allowed');
        recElements.start.disabled = false;
        recElements.timer.textContent = "00:00"; seconds = 0;
        recElements.micIcon.textContent = "mic";
        modal.classList.remove('hidden'); modal.classList.add('flex');
    };
    
    const closeModal = () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') { try { mediaRecorder.stop(); } catch(e){} }
        clearInterval(timerInt);
        modal.classList.add('hidden'); modal.classList.remove('flex');
    };

    document.body.addEventListener('click', e => {
        const openBtn = e.target.closest('.open-recitation');
        if (openBtn) {
            e.stopPropagation();
            openModal(openBtn.dataset.title, openBtn.dataset.submitUrl, openBtn.dataset.taskId);
        }
    });

    recElements.close?.addEventListener('click', closeModal);
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

    recElements.start.addEventListener('click', async () => {
        if (!navigator.mediaDevices?.getUserMedia) { return alert("المتصفح لا يدعم تسجيل الصوت."); }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            chunks = [];
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                recElements.audio.src = URL.createObjectURL(blob);
                recElements.audio.hidden = false;
                recElements.retry.disabled = false;
                recElements.submit.disabled = false; recElements.submit.classList.remove('opacity-50', 'cursor-not-allowed');
            };
            mediaRecorder.start();
            recElements.start.disabled = true;
            recElements.stop.disabled = false; recElements.stop.classList.remove('opacity-50', 'cursor-not-allowed');
            recElements.micIcon.textContent = "graphic_eq";
            seconds = 0; recElements.timer.textContent = "00:00";
            clearInterval(timerInt);
            timerInt = setInterval(() => { seconds++; recElements.timer.textContent = formatTime(seconds); }, 1000);
        } catch (err) { alert("تعذر بدء التسجيل: " + err.message); }
    });

    recElements.stop.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            clearInterval(timerInt);
            recElements.stop.disabled = true; recElements.stop.classList.add('opacity-50', 'cursor-not-allowed');
            recElements.micIcon.textContent = "mic";
        }
    });

    recElements.retry.addEventListener('click', () => {
        recElements.audio.hidden = true; recElements.audio.src = "";
        recElements.retry.disabled = true;
        recElements.submit.disabled = true; recElements.submit.classList.add('opacity-50', 'cursor-not-allowed');
        recElements.start.disabled = false;
        recElements.timer.textContent = "00:00"; seconds = 0;
    });

    recElements.submit.addEventListener('click', async () => {
        if (!currentTaskInfo.url || chunks.length === 0) return;
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const fd = new FormData();
        fd.append('audio', blob, 'recitation.webm');

        try {
            const res = await fetch(currentTaskInfo.url, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' },
                body: fd
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'حدث خطأ غير متوقع');
            
            closeModal();
            Swal.fire({
                toast: true, position: 'top-start', icon: 'success',
                title: 'تم تسليم المهمة بنجاح!', showConfirmButton: false, timer: 3000
            });

            // --- Dynamic UI Update ---
            const originalTaskCard = document.getElementById(`task-item-${currentTaskInfo.id}`);
            if(originalTaskCard) {
                const newCardHTML = data.task_card_html;
                const submittedTab = document.getElementById('submitted');
                
                originalTaskCard.remove();
                submittedTab.insertAdjacentHTML('afterbegin', newCardHTML);
                
                const pendingTasksCountStat = document.getElementById('pending-tasks-count-stat');
                if (pendingTasksCountStat) {
                    pendingTasksCountStat.textContent = data.new_stats.pending_tasks_count;
                }
            } else {
               location.reload(); // Fallback in case card is not found
            }

        } catch (err) {
            Swal.fire('خطأ!', "فشل رفع التسجيل: " + err.message, 'error');
        }
    });
});
</script>
</body>
</html>