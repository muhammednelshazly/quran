{% extends "teacher_base.html" %}
{% load static custom_tags %}

{% block title %}إدارة الحلقات{% endblock %}

{% block content %}
<header class="flex flex-col md:flex-row items-center justify-between gap-4 mb-8">
    <div class="flex items-center gap-3">
        <span class="material-symbols-outlined text-4xl text-primary">groups</span>
        <h1 class="text-3xl font-bold text-text-primary dark:text-text-primary-dark">الحلقات الخاصة بك</h1>
    </div>
    
    <div class="relative" x-data="{ open: false }">
        <button @click="open = !open" class="flex items-center gap-2 px-4 py-2 rounded-lg font-bold text-sm bg-card dark:bg-card-dark border border-border-color dark:border-border-color-dark hover:bg-background dark:hover:bg-background-dark transition-colors">
            <span class="material-symbols-outlined text-base">filter_list</span>
            <span>فرز حسب</span>
            <span class="material-symbols-outlined text-base transition-transform" :class="{'rotate-180': open}">expand_more</span>
        </button>

        <div x-show="open" @click.away="open = false" x-transition class="absolute left-0 mt-2 w-56 bg-card dark:bg-card-dark rounded-lg shadow-lifted z-10 border border-border-color dark:border-border-color-dark">
            <a href="?sort=name_asc" class="block px-4 py-2 text-sm text-text-primary dark:text-text-primary-dark hover:bg-background dark:hover:bg-background-dark {% if current_sort == 'name_asc' %}font-bold text-primary{% endif %}">الترتيب الأبجدي (أ - ي)</a>
            <a href="?sort=name_desc" class="block px-4 py-2 text-sm text-text-primary dark:text-text-primary-dark hover:bg-background dark:hover:bg-background-dark {% if current_sort == 'name_desc' %}font-bold text-primary{% endif %}">الترتيب الأبجدي (ي - أ)</a>
            <a href="?sort=students_desc" class="block px-4 py-2 text-sm text-text-primary dark:text-text-primary-dark hover:bg-background dark:hover:bg-background-dark {% if current_sort == 'students_desc' %}font-bold text-primary{% endif %}">الأكثر عددًا بالطلاب</a>
            <a href="?sort=students_asc" class="block px-4 py-2 text-sm text-text-primary dark:text-text-primary-dark hover:bg-background dark:hover:bg-background-dark {% if current_sort == 'students_asc' %}font-bold text-primary{% endif %}">الأقل عددًا بالطلاب</a>
        </div>
    </div>
</header>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for item in halaqat_list %}
    <div class="bg-card dark:bg-card-dark p-6 rounded-xl shadow-subtle border border-border-color dark:border-border-color-dark flex flex-col gap-4">
        <div class="flex justify-between items-start">
            <div>
                <h2 class="text-xl font-bold text-text-primary dark:text-text-primary-dark">{{ item.halaqa.name }}</h2>
                <p class="text-sm text-text-secondary dark:text-text-secondary-dark">نطاق الأجزاء: من {{ item.halaqa.juz_from }} إلى {{ item.halaqa.juz_to }}</p>
            </div>
            <div class="relative size-16">
                <svg class="size-full" viewBox="0 0 36 36">
                    <circle class="stroke-current text-primary/10 dark:text-primary/20" cx="18" cy="18" fill="none" r="16" stroke-width="3"></circle>
                    <circle class="stroke-current text-primary dark:text-success" cx="18" cy="18" fill="none" r="16" stroke-dasharray="100, 100" stroke-dashoffset="{{ 100|sub:item.completion_percentage }}" stroke-linecap="round" stroke-width="3" transform="rotate(-90 18 18)"></circle>
                </svg>
                <span class="absolute inset-0 flex items-center justify-center text-sm font-bold text-primary dark:text-success">{{ item.completion_percentage }}%</span>
            </div>
        </div>
        <div class="flex items-center gap-2 text-text-secondary dark:text-text-secondary-dark">
            <span class="material-symbols-outlined text-base">people</span>
            <span class="text-sm">{{ item.student_count }} طالب</span>
        </div>
        <div class="flex items-center gap-2 mt-auto pt-4 border-t border-background dark:border-border-color-dark">
            <a href="{% url 'accounts:halaqa_details' item.halaqa.id %}" class="w-full text-center bg-primary/10 text-primary py-2.5 rounded-lg text-sm font-bold hover:bg-primary/20 transition-colors">عرض التفاصيل</a>
            <button class="js-add-task-btn bg-secondary/20 text-secondary w-full py-2.5 rounded-lg text-sm font-bold hover:bg-secondary/30 transition-colors" data-halaqa-id="{{ item.halaqa.id }}" data-halaqa-name="{{ item.halaqa.name }}">
                إضافة مهمة
            </button>
        </div>
    </div>
    {% empty %}
    <div class="md:col-span-2 lg:col-span-3 bg-card dark:bg-card-dark p-6 rounded-xl shadow-subtle text-center text-text-secondary dark:text-text-secondary-dark border border-border-color dark:border-border-color-dark">
        <p>لم يتم إسناد أي حلقات لك حتى الآن.</p>
    </div>
    {% endfor %}
</div>

{% endblock %}


{% block extra_js %}
{{ block.super }}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ربط كل أزرار "إضافة مهمة" في هذه الصفحة بالنافذة العامة
    document.querySelectorAll('.js-add-task-btn').forEach(button => {
        button.addEventListener('click', function () {
            const halaqaId = this.dataset.halaqaId;
            const halaqaName = this.dataset.halaqaName;

            // نستدعي الدالة العامة من teacher_base.html
            // ونمرر لها بيانات الحلقة المحددة
            window.openAddTaskModal(halaqaId, halaqaName);
        });
    });
});
</script>
{% endblock %}