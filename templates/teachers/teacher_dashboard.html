{% extends "teacher_base.html" %}
{% load static custom_filters %}

{% block title %}الرئيسية{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-8">
    <h1 class="text-3xl font-bold text-text-primary">الرئيسية</h1>
    <div class="flex items-center gap-4">
        <span class="text-text-secondary text-lg">{{ today_date }}</span>
    </div>
</div>

<section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-card p-6 rounded-lg shadow-subtle hover:shadow-lifted hover:-translate-y-1 transition-all duration-300 border-l-4 border-primary">
        <div class="flex justify-between items-start">
            <div class="flex flex-col">
                <p class="text-sm text-text-secondary">تسليمات تنتظر التصحيح</p>
                <p class="text-4xl font-bold text-primary mt-2">{{ pending_submissions_count }}</p>
                {% if pending_submissions_count > 0 %}
                <p class="text-sm text-success mt-1">تسليم جديد</p>
                {% endif %}
            </div>
            <span class="material-symbols-outlined text-4xl text-primary/50">hourglass_top</span>
        </div>
    </div>

    <div class="bg-card p-6 rounded-lg shadow-subtle hover:shadow-lifted hover:-translate-y-1 transition-all duration-300">
        <div class="flex justify-between items-start">
            <div class="flex flex-col">
                <p class="text-sm text-text-secondary">إجمالي الطلاب</p>
                <p class="text-4xl font-bold text-text-primary mt-2">{{ total_students_count }}</p>
            </div>
            <span class="material-symbols-outlined text-4xl text-text-secondary/50">groups</span>
        </div>
    </div>

    <div class="bg-card p-6 rounded-lg shadow-subtle hover:shadow-lifted hover:-translate-y-1 transition-all duration-300">
        <div class="flex justify-between items-start">
            <div class="flex flex-col">
                <p class="text-sm text-text-secondary">الحلقات النشطة</p>
                <p class="text-4xl font-bold text-text-primary mt-2">{{ active_halaqat_count }}</p>
            </div>
            <span class="material-symbols-outlined text-4xl text-text-secondary/50">import_contacts</span>
        </div>
    </div>

    <div class="bg-card p-6 rounded-lg shadow-subtle hover:shadow-lifted hover:-translate-y-1 transition-all duration-300">
        <div class="flex justify-between items-start">
            <div class="flex flex-col">
                <p class="text-sm text-text-secondary">متوسط الأداء</p>
                <p class="text-4xl font-bold text-text-primary mt-2">{{ average_performance|floatformat:0 }}%</p>
            </div>
            <span class="material-symbols-outlined text-4xl text-text-secondary/50">trending_up</span>
        </div>
    </div>
</section>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <section class="lg:col-span-2">
        <h2 class="text-xl font-bold text-text-primary mb-4">أحدث التسليمات</h2>
        <div class="bg-card rounded-lg shadow-subtle">
            <ul class="divide-y divide-gray-200">
                {% for sub in latest_submissions %}
                <li class="p-4 flex items-center justify-between hover:bg-background transition-colors">
                    <div class="flex items-center gap-4">
                        <img alt="Student Avatar" class="w-10 h-10 rounded-full object-cover" src="{{ sub.student.avatar_url }}"/>
                        <div>
                            <p class="font-bold text-text-primary">{{ sub.student.user.username }}</p>
                            <p class="text-sm text-text-secondary">{{ sub.recitation }}</p>
                        </div>
                    </div>
                    <button class="bg-primary text-white py-2 px-4 rounded-full text-sm font-bold hover:bg-secondary transition-colors">قيّم الآن</button>
                </li>
                {% empty %}
                <li class="p-4 text-center text-text-secondary">
                    لا توجد تسليمات بانتظار التصحيح حاليًا.
                </li>
                {% endfor %}
            </ul>
        </div>
    </section>

    <section class="lg:col-span-1">
        <h2 class="text-xl font-bold text-text-primary mb-4">الحلقات</h2>
        <div id="halaqat-list-container" class="space-y-4">
            {% for item in halaqat_list %}
            <div class="halaqa-card bg-card p-4 rounded-lg shadow-subtle" data-halaqa-id="{{ item.halaqa.id }}">
                <h3 class="text-lg font-bold text-text-primary">{{ item.halaqa.name }}</h3>
                <div class="flex items-center justify-between mt-2">
                    <div class="flex items-center gap-2 text-text-secondary">
                        <span class="material-symbols-outlined text-lg">groups</span>
                        <span class="text-sm">{{ item.student_count }} طلاب</span>
                    </div>
                </div>

                <div class="text-xs text-text-secondary mt-4 pt-3 border-t border-gray-100 space-y-1">
                    {% if item.last_recitation_date %}
                        <p class="flex items-center gap-2 last-recitation-status">
                            <span class="material-symbols-outlined text-base">hearing</span>
                            <span>آخر تسميع: {{ item.last_recitation_date|arabic_timesince }}</span>
                        </p>
                    {% else %}
                         <p class="flex items-center gap-2 text-gray-400 last-recitation-status">
                            <span class="material-symbols-outlined text-base">hearing</span>
                            <span>لم تتم إضافة تسميعات بعد</span>
                        </p>
                    {% endif %}
                    {% if item.last_review_date %}
                        <p class="flex items-center gap-2 last-review-status">
                            <span class="material-symbols-outlined text-base">history</span>
                            <span>آخر مراجعة: {{ item.last_review_date|arabic_timesince }}</span>
                        </p>
                    {% else %}
                        <p class="flex items-center gap-2 text-gray-400 last-review-status">
                            <span class="material-symbols-outlined text-base">history</span>
                            <span>لم تتم إضافة مراجعات بعد</span>
                        </p>
                    {% endif %}
                </div>
                <div class="mt-4 flex gap-2">
                    <a href="{% url 'accounts:halaqa_details' item.halaqa.id %}" class="w-full text-center bg-primary text-white py-2 rounded-lg text-sm font-bold hover:bg-secondary transition-colors">عرض التفاصيل</a>
                    <button class="js-add-halaqa-task w-full bg-primary/10 text-primary py-2 rounded-lg text-sm font-bold hover:bg-primary/20 transition-colors"
                            data-halaqa-id="{{ item.halaqa.id }}"
                            data-halaqa-name="{{ item.halaqa.name }}">
                        إضافة مهمة
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="bg-card p-4 rounded-lg shadow-subtle text-center text-text-secondary">
                لم يتم إسناد أي حلقات لك بعد.
            </div>
            {% endfor %}
        </div>
    </section>
</div>

{% include "teachers/_task_form_modal.html" %}

{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const body = document.body;
    const addTaskModal = document.getElementById('addTaskModal');
    let activeModal = null;

    // --- Modal Open/Close Functions ---
    const openModal = (modalElement) => {
        if (!modalElement) return;
        activeModal = modalElement;
        activeModal.classList.add('is-visible');
        body.classList.add('modal-open');
    };

    const closeModal = () => {
        if (!activeModal) return;
        addTaskModal.querySelector('form').reset();
        activeModal.classList.remove('is-visible');
        body.classList.remove('modal-open');
        activeModal = null;
    };

    // --- Dynamic Surah Loading ---
    const loadSurahsForHalaqa = async (halaqaId) => {
        const surahSelect = addTaskModal.querySelector('#surah-select');
        surahSelect.innerHTML = '<option value="">جاري تحميل السور...</option>';
        surahSelect.disabled = true;
        try {
            const response = await fetch(`/accounts/api/halaqa/${halaqaId}/surahs/`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            surahSelect.innerHTML = '<option value="" disabled selected>اختر السورة</option>';
            data.surahs.forEach(surah => {
                const option = new Option(surah.name, surah.id);
                surahSelect.add(option);
            });
            surahSelect.disabled = false;
        } catch (error) {
            console.error('Failed to load surahs:', error);
            surahSelect.innerHTML = '<option value="">فشل تحميل السور</option>';
        }
    };

    // --- Dynamic UI Update ---
    const updateHalaqaCardUI = (formData) => {
        const halaqaId = formData.get('halaqa_id');
        const taskType = formData.get('task_type');
        const card = document.querySelector(`.halaqa-card[data-halaqa-id="${halaqaId}"]`);
        if (!card) return;

        let statusElement;
        if (taskType === 'recitation') {
            statusElement = card.querySelector('.last-recitation-status');
            if (statusElement) {
                statusElement.innerHTML = `<span class="material-symbols-outlined text-base">hearing</span> <span>آخر تسميع: الآن</span>`;
                statusElement.classList.remove('text-gray-400');
            }
        } else if (taskType === 'review') {
            statusElement = card.querySelector('.last-review-status');
            if (statusElement) {
                statusElement.innerHTML = `<span class="material-symbols-outlined text-base">history</span> <span>آخر مراجعة: الآن</span>`;
                statusElement.classList.remove('text-gray-400');
            }
        }
    };

    // --- Event Delegation & Listeners ---
    document.addEventListener('click', function(event) {
        const addTaskButton = event.target.closest('.js-add-halaqa-task');
        if (addTaskButton) {
            const halaqaName = addTaskButton.dataset.halaqaName;
            const halaqaId = addTaskButton.dataset.halaqaId;
            addTaskModal.querySelector('#modal-halaqa-name').textContent = halaqaName;
            addTaskModal.querySelector('#task-halaqa-id').value = halaqaId;
            loadSurahsForHalaqa(halaqaId);
            openModal(addTaskModal);
            return;
        }
        if (event.target.closest('.js-close-modal')) {
            closeModal();
            return;
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && activeModal) { closeModal(); }
    });
    
    // --- Task Type Selector Logic ---
    const taskTypeInput = addTaskModal.querySelector('#task-type-input');
    const recitationBtn = addTaskModal.querySelector('#recitation-btn');
    const reviewBtn = addTaskModal.querySelector('#review-btn');
    const activeClasses = ['bg-white', 'text-primary', 'shadow-sm'];
    const inactiveClasses = ['text-text-secondary', 'bg-transparent', 'shadow-none'];
    recitationBtn.addEventListener('click', () => {
        recitationBtn.classList.add(...activeClasses); recitationBtn.classList.remove(...inactiveClasses);
        reviewBtn.classList.add(...inactiveClasses); reviewBtn.classList.remove(...activeClasses);
        taskTypeInput.value = 'recitation';
    });
    reviewBtn.addEventListener('click', () => {
        reviewBtn.classList.add(...activeClasses); reviewBtn.classList.remove(...inactiveClasses);
        recitationBtn.classList.add(...inactiveClasses); recitationBtn.classList.remove(...activeClasses);
        taskTypeInput.value = 'review';
    });

    // --- Form Submission Logic ---
    const addTaskForm = document.getElementById('addHalaqaTaskForm');
    if (addTaskForm) {
        addTaskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(addTaskForm);
            const submitButton = addTaskForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.classList.add('opacity-50');

            fetch(addTaskForm.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
            })
            .then(response => response.json().then(data => ({ok: response.ok, data})))
            .then(({ok, data}) => {
                if (ok) {
                    Swal.fire({
                        toast: true,
                        position: 'top-start',
                        icon: 'success',
                        title: data.message,
                        showConfirmButton: false,
                        timer: 3500,
                        timerProgressBar: true,
                    });
                    closeModal();
                    updateHalaqaCardUI(formData);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'حدث خطأ',
                        text: data.message || 'لم يتم تحديد الخطأ من الخادم.',
                        confirmButtonText: 'حسنًا'
                    });
                }
            })
            .catch(error => {
                console.error('Submission error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ في الاتصال',
                    text: 'فشل إرسال البيانات. يرجى التحقق من الـ Console لمزيد من التفاصيل.',
                    confirmButtonText: 'حسنًا'
                });
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50');
            });
        });
    }
});
</script>
{% endblock %}