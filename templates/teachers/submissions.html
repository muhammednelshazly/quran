{% extends "teacher_base.html" %}
{% load static custom_filters %}

{% block title %}إدارة التسليمات - منصة آية{% endblock %}

{% block content %}
<header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
    <div>
        <h2 class="text-3xl font-extrabold text-text-primary dark:text-text-primary-dark">إدارة التسليمات</h2>
        <p class="text-text-secondary dark:text-text-secondary-dark mt-1">تقييم ومتابعة تسميعات ومراجعات الطلاب.</p>
    </div>
    <div class="flex items-center gap-2">
        <div class="relative">
            <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-text-secondary dark:text-text-secondary-dark pointer-events-none">search</span>
            <input type="text" id="searchInput" placeholder="بحث باسم الطالب..." class="w-full sm:w-64 bg-card dark:bg-card-dark border border-border-color dark:border-border-color-dark rounded-lg pl-4 pr-10 py-2 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition">
        </div>
    </div>
</header>

<section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-card dark:bg-card-dark border border-border-color dark:border-border-color-dark p-6 rounded-xl shadow-subtle flex items-center gap-5">
        <div class="bg-secondary/10 dark:bg-secondary/20 text-secondary p-3 rounded-full"><span class="material-symbols-outlined text-2xl">pending_actions</span></div>
        <div>
            <p class="text-sm font-medium text-text-secondary dark:text-text-secondary-dark">بانتظار التقييم</p>
            <p class="text-3xl font-bold text-text-primary dark:text-text-primary-dark mt-1" id="pending-count">{{ pending_count }}</p>
        </div>
    </div>
    <div class="bg-card dark:bg-card-dark border border-border-color dark:border-border-color-dark p-6 rounded-xl shadow-subtle flex items-center gap-5">
        <div class="bg-green-500/10 dark:bg-green-500/20 text-green-500 p-3 rounded-full"><span class="material-symbols-outlined text-2xl">check_circle</span></div>
        <div>
            <p class="text-sm font-medium text-text-secondary dark:text-text-secondary-dark">مكتملة هذا الأسبوع</p>
            <p class="text-3xl font-bold text-text-primary dark:text-text-primary-dark mt-1">{{ completed_this_week_count }}</p>
        </div>
    </div>
    <div class="bg-card dark:bg-card-dark border border-border-color dark:border-border-color-dark p-6 rounded-xl shadow-subtle flex items-center gap-5">
        <div class="bg-red-500/10 dark:bg-red-500/20 text-red-500 p-3 rounded-full"><span class="material-symbols-outlined text-2xl">error</span></div>
        <div>
            <p class="text-sm font-medium text-text-secondary dark:text-text-secondary-dark">تحتاج لإعادة</p>
            <p class="text-3xl font-bold text-text-primary dark:text-text-primary-dark mt-1">{{ needs_resubmission_count }}</p>
        </div>
    </div>
    <div class="bg-card dark:bg-card-dark border border-border-color dark:border-border-color-dark p-6 rounded-xl shadow-subtle flex items-center gap-5">
         <div class="bg-primary/10 dark:bg-primary/20 text-primary p-3 rounded-full"><span class="material-symbols-outlined text-2xl">schedule</span></div>
        <div>
            <p class="text-sm font-medium text-text-secondary dark:text-text-secondary-dark">متوسط وقت التقييم</p>
            <p class="text-3xl font-bold text-text-primary dark:text-text-primary-dark mt-1">{{ average_grading_time }}</p>
        </div>
    </div>
</section>

<section class="bg-card dark:bg-card-dark rounded-xl shadow-subtle border border-border-color dark:border-border-color-dark">
    <div class="p-4 sm:p-6 border-b border-border-color dark:border-border-color-dark" x-data="{ open: false }">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="w-full flex flex-col md:flex-row gap-4">
                <div class="flex items-center gap-2 bg-background dark:bg-background-dark p-1.5 rounded-lg">
                    <a href="?status=submitted&type={{ active_type_filter }}&halaqa={{ active_halaqa_filter }}" class="px-4 py-1.5 text-sm rounded-md {% if active_filter == 'submitted' %}font-bold bg-card dark:bg-card-dark text-primary dark:text-success shadow-sm{% else %}font-medium text-text-secondary dark:text-text-secondary-dark{% endif %}">بانتظار التقييم</a>
                    <a href="?status=graded&type={{ active_type_filter }}&halaqa={{ active_halaqa_filter }}" class="px-4 py-1.5 text-sm rounded-md {% if active_filter == 'graded' %}font-bold bg-card dark:bg-card-dark text-primary dark:text-success shadow-sm{% else %}font-medium text-text-secondary dark:text-text-secondary-dark{% endif %}">المكتملة</a>
                    <a href="?status=all&type={{ active_type_filter }}&halaqa={{ active_halaqa_filter }}" class="px-4 py-1.5 text-sm rounded-md {% if active_filter == 'all' %}font-bold bg-card dark:bg-card-dark text-primary dark:text-success shadow-sm{% else %}font-medium text-text-secondary dark:text-text-secondary-dark{% endif %}">الكل</a>
                </div>

                <div class="flex items-center gap-2 bg-background dark:bg-background-dark p-1.5 rounded-lg">
                    <a href="?status={{ active_filter }}&type=all&halaqa={{ active_halaqa_filter }}" class="px-4 py-1.5 text-sm rounded-md {% if active_type_filter == 'all' %}font-bold bg-card dark:bg-card-dark text-primary dark:text-success shadow-sm{% else %}font-medium text-text-secondary dark:text-text-secondary-dark{% endif %}">كل الأنواع</a>
                    <a href="?status={{ active_filter }}&type=recitation&halaqa={{ active_halaqa_filter }}" class="px-4 py-1.5 text-sm rounded-md {% if active_type_filter == 'recitation' %}font-bold bg-card dark:bg-card-dark text-primary dark:text-success shadow-sm{% else %}font-medium text-text-secondary dark:text-text-secondary-dark{% endif %}">تسميعات فقط</a>
                    <a href="?status={{ active_filter }}&type=review&halaqa={{ active_halaqa_filter }}" class="px-4 py-1.5 text-sm rounded-md {% if active_type_filter == 'review' %}font-bold bg-card dark:bg-card-dark text-primary dark:text-success shadow-sm{% else %}font-medium text-text-secondary dark:text-text-secondary-dark{% endif %}">مراجعات فقط</a>
                </div>
            </div>

            <div class="relative w-full sm:w-auto">
                <button @click="open = !open" class="w-full flex items-center justify-between gap-2 px-4 py-2 rounded-lg font-bold text-sm bg-background dark:bg-background-dark border border-border-color dark:border-border-color-dark hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors">
                    <span class="material-symbols-outlined text-base">filter_list</span>
                    <span class="whitespace-nowrap">
                        {% if active_halaqa_filter_name %}
                            {{ active_halaqa_filter_name }}
                        {% else %}
                            فلترة حسب الحلقة
                        {% endif %}
                    </span>
                    <span class="material-symbols-outlined text-base transition-transform" :class="{'rotate-180': open}">expand_more</span>
                </button>
        
                <div x-show="open" @click.away="open = false" x-transition class="absolute left-0 mt-2 w-full sm:w-64 bg-card dark:bg-card-dark rounded-lg shadow-lifted z-10 border border-border-color dark:border-border-color-dark">
                    <a href="?status={{ active_filter }}&type={{ active_type_filter }}" class="block px-4 py-2 text-sm text-text-primary dark:text-text-primary-dark hover:bg-background dark:hover:bg-background-dark {% if not active_halaqa_filter %}font-bold text-primary dark:text-success{% endif %}">كل الحلقات</a>
                    {% for halaqa in teacher_halaqas %}
                    <a href="?status={{ active_filter }}&type={{ active_type_filter }}&halaqa={{ halaqa.id }}" class="block px-4 py-2 text-sm text-text-primary dark:text-text-primary-dark hover:bg-background dark:hover:bg-background-dark {% if active_halaqa_filter == halaqa.id|stringformat:"s" %}font-bold text-primary dark:text-success{% endif %}">{{ halaqa.name }}</a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="overflow-x-auto">
        <table class="w-full text-right" id="submissions-table">
            <thead class="bg-gray-50 dark:bg-white/5">
                <tr>
                    <th scope="col" class="px-6 py-3 font-semibold text-sm text-text-primary dark:text-text-primary-dark">الطالب</th>
                    <th scope="col" class="px-6 py-3 font-semibold text-sm text-text-primary dark:text-text-primary-dark">الحلقة</th>
                    <th scope="col" class="px-6 py-3 font-semibold text-sm text-text-primary dark:text-text-primary-dark">النطاق</th>
                    <th scope="col" class="px-6 py-3 font-semibold text-sm text-text-primary dark:text-text-primary-dark text-center">التقييم</th>
                    <th scope="col" class="px-6 py-3 font-semibold text-sm text-text-primary dark:text-text-primary-dark">تاريخ التسليم</th>
                    <th scope="col" class="px-6 py-3 font-semibold text-sm text-text-primary dark:text-text-primary-dark text-center">الإجراء</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-border-color dark:divide-border-color-dark">
                {% for sub in submissions %}
                {# --- بداية التعديل 1: تحديد نوع التسليم --- #}
                {% with sub_type=sub.recitation|yesno:"recitation,review" %}
                <tr class="submission-row hover:bg-background dark:hover:bg-background-dark/50 transition-colors" data-submission-id="{{ sub.id }}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-3">
                            <img class="h-10 w-10 rounded-full object-cover" src="{{ sub.student.avatar_url }}" alt="{{ sub.student.user.username }} avatar">
                            <div>
                                <div class="text-sm font-bold text-text-primary dark:text-text-primary-dark student-name">{{ sub.student.user.username }}</div>
                                <div class="text-xs text-text-secondary dark:text-text-secondary-dark">
                                    {% if sub.recitation %}تسميع{% else %}مراجعة{% endif %}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-text-secondary dark:text-text-secondary-dark halaqa-name">
                        {% if sub.recitation %}{{ sub.recitation.halaqa.name }}{% else %}{{ sub.review.halaqa.name }}{% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium dark:text-text-primary-dark">
                        {% if sub.recitation %}{{ sub.recitation }}{% else %}{{ sub.review }}{% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-center {% if sub.score is not None and sub.score >= 8 %}text-green-600 dark:text-green-400{% elif sub.score is not None %}text-red-600 dark:text-red-400{% endif %}">
                        {{ sub.score|floatformat:1 }}/10 {% if sub.score is None %}-{% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-text-secondary dark:text-text-secondary-dark">
                        {{ sub.created_at|arabic_timesince }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        {% if sub.status == 'submitted' %}
                        <button class="js-grade-submission bg-primary hover:bg-primary/90 text-white text-sm font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors" data-submission-id="{{ sub.id }}" data-submission-type="{{ sub_type }}">
                            <span class="material-symbols-outlined text-base">play_arrow</span>
                            <span>تقييم الآن</span>
                        </button>
                        {% elif sub.status == 'graded' %}
                        <button class="js-grade-submission bg-primary/10 hover:bg-primary/20 text-primary dark:text-success dark:bg-success/20 dark:hover:bg-success/30 text-sm font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors" data-submission-id="{{ sub.id }}" data-submission-type="{{ sub_type }}">
                            <span class="material-symbols-outlined text-base">visibility</span>
                            <span>عرض التقييم</span>
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endwith %} 
                {# --- نهاية التعديل 1 --- #}
                {% empty %}
                <tr>
                    <td colspan="6" class="p-6 text-center text-text-secondary dark:text-text-secondary-dark">
                        لا توجد تسليمات تطابق هذا الفلتر.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}


{% block extra_js %}
{{ block.super }}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<div class="modal fixed inset-0 z-50 p-4" id="gradeSubmissionModal">
    <div class="modal-overlay fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm js-close-modal"></div>
    <div class="w-full h-full flex items-center justify-center">
        <div class="modal-content relative bg-card dark:bg-card-dark rounded-lg shadow-2xl w-full max-w-2xl">
            <button class="absolute top-4 left-4 text-text-secondary dark:text-text-secondary-dark hover:text-text-primary dark:hover:text-text-primary-dark transition-colors js-close-modal" title="إغلاق">
                <span class="material-symbols-outlined">close</span>
            </button>
            <div id="modal-loader" class="p-12 text-center text-text-secondary dark:text-text-secondary-dark">
                <p>جاري تحميل البيانات...</p>
            </div>
            <div id="modal-grade-content" class="hidden">
                <form id="gradeSubmissionForm" method="POST">
                    {% csrf_token %}
                    <div class="p-8">
                        <div class="flex items-start gap-5 mb-6">
                            <img id="modal-student-avatar" class="w-16 h-16 rounded-full object-cover ring-4 ring-primary/20 dark:ring-success/20" src="" alt="Student Avatar">
                            <div>
                                <h2 id="modal-student-name" class="text-2xl font-bold text-text-primary dark:text-text-primary-dark"></h2>
                                <p id="modal-recitation-title" class="text-lg text-primary dark:text-success"></p>
                            </div>
                        </div>
                        <div class="mb-6">
                            <audio id="modal-audio-player" class="w-full" controls src=""></audio>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-background dark:bg-background-dark/50 p-4 rounded-lg border border-border-color dark:border-border-color-dark">
                                <h3 class="font-bold mb-3 text-center text-text-primary dark:text-text-primary-dark">تقييم الحفظ (من 5)</h3>
                                <div class="flex items-center justify-center gap-2">
                                    <input type="range" name="hifdh" min="0" max="5" value="5" step="0.5" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-primary dark:accent-success" oninput="this.nextElementSibling.textContent = this.value">
                                    <span class="font-bold text-lg text-primary dark:text-success w-10 text-center">5</span>
                                </div>
                            </div>
                            <div class="bg-background dark:bg-background-dark/50 p-4 rounded-lg border border-border-color dark:border-border-color-dark">
                                <h3 class="font-bold mb-3 text-center text-text-primary dark:text-text-primary-dark">تقييم الأحكام (من 5)</h3>
                                <div class="flex items-center justify-center gap-2">
                                    <input type="range" name="rules" min="0" max="5" value="5" step="0.5" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-primary dark:accent-success" oninput="this.nextElementSibling.textContent = this.value">
                                    <span class="font-bold text-lg text-primary dark:text-success w-10 text-center">5</span>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                 <label for="notes" class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-1">ملاحظات (اختياري)</label>
                                 <textarea name="notes" rows="3" placeholder="اكتب ملاحظاتك للطالب هنا..." class="w-full bg-background dark:bg-background-dark/50 border border-border-color dark:border-border-color-dark rounded-lg py-2.5 px-4 focus:ring-primary focus:border-primary placeholder-text-secondary dark:placeholder-text-secondary-dark text-text-primary dark:text-text-primary-dark transition-colors"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="bg-background dark:bg-card-dark/50 px-8 py-4 flex justify-end gap-3 rounded-b-lg border-t border-gray-100 dark:border-border-color-dark/50">
                        <button type="button" class="js-close-modal bg-gray-200 dark:bg-gray-700 text-text-secondary dark:text-text-primary-dark px-6 py-2.5 rounded-lg font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">إلغاء</button>
                        <button type="submit" class="bg-primary text-white flex items-center gap-2 px-6 py-2.5 rounded-lg font-bold hover:bg-secondary transition-colors">
                            <span class="material-symbols-outlined">check_circle</span>
                            <span>حفظ التقييم</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const gradeModal = document.getElementById('gradeSubmissionModal');
    let currentSubmissionId = null;

    // Open grading modal and fetch data
    document.addEventListener('click', async function(event) {
        const gradeButton = event.target.closest('.js-grade-submission');
        if (gradeButton) {
            currentSubmissionId = gradeButton.dataset.submissionId;
            
            // --- بداية التعديل 2: جلب النوع وتحديث رابط الـ API ---
            const submissionType = gradeButton.dataset.submissionType;
            // --- نهاية التعديل 2 ---
            
            const gradeForm = document.getElementById('gradeSubmissionForm');
            const gradeLoader = document.getElementById('modal-loader');
            const gradeContent = document.getElementById('modal-grade-content');
            
            gradeForm.action = `/accounts/teacher/submission/${submissionType}/${currentSubmissionId}/grade/`;
            
            gradeLoader.style.display = 'block';
            gradeContent.classList.add('hidden');
            openModal(gradeModal);

            try {
                // --- بداية التعديل 2: استخدام الرابط الجديد ---
                const response = await fetch(`/accounts/api/submission/${submissionType}/${currentSubmissionId}/`);
                // --- نهاية التعديل 2 ---

                if (!response.ok) throw new Error('Failed to load data');
                const data = await response.json();

                // Populate modal
                document.getElementById('modal-student-avatar').src = data.avatar_url;
                document.getElementById('modal-student-name').textContent = data.student_name;
                document.getElementById('modal-recitation-title').textContent = data.recitation_title;
                document.getElementById('modal-audio-player').src = data.audio_url;

                const hifdhInput = gradeForm.querySelector('input[name="hifdh"]');
                const rulesInput = gradeForm.querySelector('input[name="rules"]');
                hifdhInput.value = data.current_hifdh;
                hifdhInput.nextElementSibling.textContent = data.current_hifdh;
                rulesInput.value = data.current_rules;
                rulesInput.nextElementSibling.textContent = data.current_rules;
                gradeForm.querySelector('textarea[name="notes"]').value = data.current_notes;

                gradeLoader.style.display = 'none';
                gradeContent.classList.remove('hidden');
            } catch (error) {
                console.error("Error fetching submission details:", error);
                closeModal();
                Swal.fire('خطأ', 'لم نتمكن من جلب تفاصيل التسليم.', 'error');
            }
        }
    });

    // Submit grading form
    const gradeForm = document.getElementById('gradeSubmissionForm');
    if (gradeForm) {
        gradeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(gradeForm);
            const data = {
                hifdh: formData.get('hifdh'),
                rules: formData.get('rules'),
                notes: formData.get('notes'),
            };
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const submitButton = gradeForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.classList.add('opacity-50');

            try {
                const response = await fetch(gradeForm.action, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    Swal.fire({
                        toast: true, position: 'top-start', icon: 'success',
                        title: result.message, showConfirmButton: false, timer: 3000
                    });
                    closeModal();
                    
                    const row = document.querySelector(`tr[data-submission-id="${currentSubmissionId}"]`);
                    if(row) { row.remove(); }
                    
                    document.getElementById('pending-count').textContent = result.stats.pending_submissions_count;

                } else {
                    throw new Error(result.message || 'Unknown error occurred');
                }
            } catch (error) {
                Swal.fire('خطأ', error.message, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50');
            }
        });
    }

    // JS-based search and filter
    const searchInput = document.getElementById('searchInput');
    const tableBody = document.getElementById('submissions-table').querySelector('tbody');

    function filterTable() {
        // We get the current URL to find the active halaqa filter from the query params
        const currentUrl = new URL(window.location);
        const halaqaFilterValue = currentUrl.searchParams.get('halaqa'); // This is the halaqa ID
        
        // Find the halaqa NAME from the dropdown options based on the ID
        let halaqaText = "";
        if (halaqaFilterValue) {
            const halaqaDropdownLinks = document.querySelectorAll('a[href*="halaqa="]');
            for(let link of halaqaDropdownLinks){
                const urlParams = new URLSearchParams(link.search);
                if(urlParams.get('halaqa') === halaqaFilterValue){
                    halaqaText = link.textContent.trim();
                    break;
                }
            }
        }

        const searchText = searchInput.value.toLowerCase();
        
        tableBody.querySelectorAll('tr.submission-row').forEach(row => {
            const studentName = row.querySelector('.student-name').textContent.toLowerCase();
            const halaqaName = row.querySelector('.halaqa-name').textContent.trim();
            
            const matchesSearch = studentName.includes(searchText);
            const matchesHalaqa = halaqaText === "" || halaqaName === halaqaText;
            
            row.style.display = (matchesSearch && matchesHalaqa) ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterTable);
    // Initial filter on page load in case of search query
    filterTable();

});
</script>
{% endblock %}