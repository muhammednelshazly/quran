{% extends "teacher_base.html" %}
{% load static %}

{% block title %}الإعدادات{% endblock %}

{% block content %}
{# أضفنا `method` و `enctype` و `id` و CSRF token للنموذج الرئيسي #}
<form id="settings-form" method="POST" action="{% url 'accounts:teacher_settings' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-extrabold text-text-primary dark:text-text-primary-dark">الإعدادات</h1>
            <p class="text-text-secondary dark:text-text-secondary-dark mt-1">إدارة معلومات حسابك وتفضيلاتك.</p>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-8">

            <section class="bg-card dark:bg-card-dark p-6 rounded-xl shadow-subtle border border-border-color dark:border-border-color-dark">
                <h3 class="text-xl font-bold text-text-primary dark:text-text-primary-dark mb-6">المعلومات الشخصية</h3>
                <div class="space-y-6">
                    <div class="flex items-center gap-5">
                        <img id="avatar-preview" src="{{ user.profile.avatar_url }}" alt="الصورة الشخصية" class="w-20 h-20 rounded-full object-cover ring-4 ring-primary/10 dark:ring-success/20">
                        <div class="flex items-center gap-2">
                            <label for="avatar-upload" class="cursor-pointer bg-primary/10 text-primary dark:bg-success/20 dark:text-success font-bold py-2 px-4 rounded-lg text-sm hover:bg-primary/20 dark:hover:bg-success/30 transition-colors">
                                تغيير الصورة
                            </label>
                            <input type="file" id="avatar-upload" name="avatar" class="hidden" accept="image/*">
                            {# زر إزالة الصورة أصبح له `id` لتفعيله #}
                            <button type="button" id="remove-avatar-btn" class="text-text-secondary dark:text-text-secondary-dark font-bold py-2 px-4 rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">إزالة</button>
                            <input type="hidden" name="remove_avatar" id="remove-avatar-input" value="false">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-2" for="username">الاسم</label>
                            {# تم تغيير id إلى username ليتوافق مع الموديل #}
                            <input class="w-full p-3 bg-background dark:bg-background-dark border border-border-color dark:border-border-color-dark rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition" id="username" name="username" type="text" value="{{ user.username }}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-2" for="email">البريد الإلكتروني</label>
                            <input class="w-full p-3 bg-background dark:bg-background-dark border border-border-color dark:border-border-color-dark rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition" id="email" name="email" type="email" value="{{ user.email }}">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-2" for="password">كلمة المرور الجديدة</label>
                        {# أضفنا `name` للحقول لتُرسل مع الفورم #}
                        <input class="w-full p-3 bg-background dark:bg-background-dark border border-border-color dark:border-border-color-dark rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition" id="password" name="password" placeholder="اتركها فارغة لعدم التغيير" type="password">
                    </div>
                </div>
            </section>

            <section class="bg-card dark:bg-card-dark p-6 rounded-xl shadow-subtle border border-border-color dark:border-border-color-dark">
                <h3 class="text-xl font-bold text-text-primary dark:text-text-primary-dark mb-6">تفضيلات الإشعارات</h3>
                <div class="space-y-4 divide-y divide-border-color dark:divide-border-color-dark">
                    <div class="flex items-center justify-between pt-4 first:pt-0">
                        <div>
                            <p class="font-semibold text-text-primary dark:text-text-primary-dark">إشعارات البريد الإلكتروني</p>
                            <p class="text-sm text-text-secondary dark:text-text-secondary-dark">تلقي ملخصات وإشعارات هامة على بريدك.</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="email_notifications" class="sr-only peer" {% if user.profile.email_notifications %}checked{% endif %}>
                            <div class="w-11 h-6 bg-gray-200 dark:bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-secondary/50 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary dark:peer-checked:bg-success"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between pt-4">
                        <div>
                            <p class="font-semibold text-text-primary dark:text-text-primary-dark">إشعارات داخل التطبيق</p>
                            <p class="text-sm text-text-secondary dark:text-text-secondary-dark">عند استلام تسليم جديد من طالب.</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="app_notifications" class="sr-only peer" {% if user.profile.app_notifications %}checked{% endif %}>
                            <div class="w-11 h-6 bg-gray-200 dark:bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-secondary/50 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary dark:peer-checked:bg-success"></div>
                        </label>
                    </div>
                </div>
            </section>
            
            <section class="p-6 rounded-xl shadow-subtle border-2 border-red-500/30 dark:border-red-500/50 bg-red-500/5">
                <h3 class="text-xl font-bold text-red-800 dark:text-red-400">منطقة الخطر</h3>
                <p class="text-sm text-red-700 dark:text-red-300 mt-2 mb-4">الإجراءات التالية لا يمكن التراجع عنها. يرجى التعامل معها بحذر.</p>
                <button type="button" id="delete-account-btn" class="bg-red-500/10 text-red-700 dark:bg-red-500/20 dark:text-red-300 font-bold py-2 px-4 rounded-lg text-sm hover:bg-red-500/20 dark:hover:bg-red-500/30 transition-colors">
                    حذف الحساب
                </button>
            </section>
        </div>

        <div class="lg:col-span-1 space-y-8">
            <section class="bg-card dark:bg-card-dark p-6 rounded-xl shadow-subtle border border-border-color dark:border-border-color-dark">
                <h3 class="text-xl font-bold text-text-primary dark:text-text-primary-dark mb-6 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary dark:text-success">security</span>
                    <span>الأمان وجلسات الدخول</span>
                </h3>
                <div class="space-y-4 text-sm">
                    <div class="flex justify-between items-center text-text-secondary dark:text-text-secondary-dark">
                        <span>آخر تسجيل دخول:</span>
                        {# أصبح التاريخ ديناميكيًا الآن #}
                        <span class="font-semibold text-text-primary dark:text-text-primary-dark">{% if user.last_login %}{{ user.last_login|date:"j F Y, g:i A" }}{% else %}لم يسجل بعد{% endif %}</span>
                    </div>
                     <button type="button" id="logout-others-btn" class="w-full text-center bg-gray-100 dark:bg-gray-700 text-text-primary dark:text-text-primary-dark font-bold py-2.5 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        تسجيل الخروج من الأجهزة الأخرى
                    </button>
                </div>
            </section>

            <section class="bg-card dark:bg-card-dark p-6 rounded-xl shadow-subtle border border-border-color dark:border-border-color-dark">
                <h3 class="text-xl font-bold text-text-primary dark:text-text-primary-dark mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary dark:text-success">help_outline</span>
                    <span>المساعدة والدعم</span>
                </h3>
                <p class="text-sm text-text-secondary dark:text-text-secondary-dark mb-4">
                    هل تواجه مشكلة؟ فريقنا مستعد لمساعدتك.
                </p>
                <div class="flex flex-col gap-3">
                     <a href="#" class="w-full text-center bg-primary/10 dark:bg-success/20 text-primary dark:text-success font-bold py-2.5 px-4 rounded-lg hover:bg-primary/20 dark:hover:bg-success/30 transition-colors">
                        مركز المساعدة
                    </a>
                    <a href="#" class="w-full text-center bg-gray-100 dark:bg-gray-700 text-text-primary dark:text-text-primary-dark font-bold py-2.5 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        تواصل معنا
                    </a>
                </div>
            </section>
        </div>
    </div>

    <div class="sticky bottom-0 right-0 lg:right-[16rem] mr-[-1.5rem] lg:mr-[-2rem] mt-8">
         <div class="bg-card/80 dark:bg-card-dark/80 backdrop-blur-sm p-4 border-t border-border-color dark:border-border-color-dark flex justify-end gap-3 shadow-lifted">
            {# زر الإلغاء الآن يقوم بإعادة تعيين الفورم #}
            <button type="reset" class="bg-gray-200 dark:bg-gray-700 text-text-secondary dark:text-text-secondary-dark px-6 py-2.5 rounded-lg font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                إلغاء
            </button>
            <button type="submit" id="save-changes-btn" class="bg-primary text-white flex items-center gap-2 px-6 py-2.5 rounded-lg font-bold hover:bg-secondary transition-colors">
                <span>حفظ التغييرات</span>
            </button>
        </div>
    </div>
</form>
{% endblock %}


{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const settingsForm = document.getElementById('settings-form');
    const avatarUpload = document.getElementById('avatar-upload');
    const avatarPreview = document.getElementById('avatar-preview');
    const removeAvatarBtn = document.getElementById('remove-avatar-btn');
    const removeAvatarInput = document.getElementById('remove-avatar-input');
    const deleteAccountBtn = document.getElementById('delete-account-btn');
    const logoutOthersBtn = document.getElementById('logout-others-btn');
    const saveChangesBtn = document.getElementById('save-changes-btn');
    
    const getCsrfToken = () => document.querySelector('[name=csrfmiddlewaretoken]').value;

    // --- معاينة الصورة الشخصية ---
    if (avatarUpload && avatarPreview) {
        avatarUpload.addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => avatarPreview.src = e.target.result;
                reader.readAsDataURL(file);
                // عند اختيار صورة جديدة، نتأكد من أننا لا نحذفها
                removeAvatarInput.value = 'false';
            }
        });
    }

    // --- زر إزالة الصورة ---
    if (removeAvatarBtn) {
        removeAvatarBtn.addEventListener('click', () => {
            avatarUpload.value = ''; // مسح أي ملف تم اختياره
            avatarPreview.src = "{{ default_avatar_url }}"; // عرض الصورة الافتراضية
            removeAvatarInput.value = 'true'; // إرسال إشارة للخادم للحذف
            Swal.fire({
                toast: true, position: 'top-start', icon: 'info',
                title: 'سيتم إزالة الصورة عند الحفظ.', showConfirmButton: false, timer: 3000
            });
        });
    }

    // --- حفظ التغييرات الرئيسية (AJAX) ---
    if (settingsForm) {
        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(settingsForm);
            const originalButtonText = saveChangesBtn.innerHTML;
            saveChangesBtn.innerHTML = '<span>جاري الحفظ...</span>';
            saveChangesBtn.disabled = true;

            try {
                const response = await fetch(settingsForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': getCsrfToken() }
                });
                const result = await response.json();

                if (response.ok) {
                    Swal.fire('تم بنجاح', result.message, 'success');
                    // تحديث الصورة في الشريط الجانبي إذا تغيرت
                    if (result.new_avatar_url) {
                         document.querySelector('aside img[alt="Avatar"]').src = result.new_avatar_url;
                    }
                } else {
                    Swal.fire('خطأ', result.message || 'فشل حفظ التغييرات.', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire('خطأ', 'حدث خطأ في الشبكة. يرجى المحاولة مرة أخرى.', 'error');
            } finally {
                saveChangesBtn.innerHTML = originalButtonText;
                saveChangesBtn.disabled = false;
            }
        });
    }
    
    // --- تسجيل الخروج من الأجهزة الأخرى ---
    if (logoutOthersBtn) {
        logoutOthersBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: "سيتم تسجيل خروجك من جميع الأجهزة الأخرى.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#386641',
                cancelButtonColor: '#d33',
                confirmButtonText: 'نعم، قم بذلك',
                cancelButtonText: 'إلغاء'
            }).then(async (result) => {
                if (result.isConfirmed) {
                     try {
                        const response = await fetch("{% url 'accounts:logout_other_devices' %}", {
                            method: 'POST',
                            headers: { 'X-CSRFToken': getCsrfToken() }
                        });
                        const data = await response.json();
                        if (response.ok) {
                             Swal.fire('نجاح', data.message, 'success');
                        } else {
                            throw new Error(data.message);
                        }
                     } catch(error) {
                        Swal.fire('خطأ', error.message || 'فشل تنفيذ الإجراء', 'error');
                     }
                }
            })
        });
    }

    // --- حذف الحساب ---
    if (deleteAccountBtn) {
        deleteAccountBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'هل أنت متأكد تمامًا؟',
                html: `سيتم حذف حسابك بشكل نهائي. هذا الإجراء لا يمكن التراجع عنه. <br/> الرجاء كتابة "<b>حذف</b>" للتأكيد.`,
                icon: 'error',
                input: 'text',
                inputPlaceholder: 'اكتب "حذف" هنا',
                showCancelButton: true,
                confirmButtonText: 'تأكيد الحذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                preConfirm: (value) => {
                    if (value !== 'حذف') {
                        Swal.showValidationMessage('يجب كتابة "حذف" بشكل صحيح للمتابعة.')
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch("{% url 'accounts:delete_account' %}", {
                           method: 'POST',
                           headers: { 'X-CSRFToken': getCsrfToken() }
                        });
                        const data = await response.json();
                        if (response.ok) {
                            await Swal.fire('تم الحذف', data.message, 'success');
                            window.location.href = "{% url 'accounts:go' %}"; // أو أي صفحة أخرى
                        } else {
                            throw new Error(data.message);
                        }
                    } catch(error) {
                        Swal.fire('خطأ', error.message || 'فشل حذف الحساب', 'error');
                    }
                }
            });
        });
    }
});
</script>
{% endblock %}